name: Prediction Automation

on:
  schedule:
    - cron: '30 */4 * * *'  # ë§¤ 4ì‹œê°„ 30ë¶„ ì „ì— ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ íŠ¸ë¦¬ê±° ì¶”ê°€
  issues:
    types: [closed]  # ì´ìŠˆê°€ ë‹«í ë•Œ

jobs:
  create-prediction:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Get Current Price
        id: price
        uses: actions/github-script@v6
        with:
          script: |
            const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
            const data = await response.json();
            return data.price;
      
      - name: Create Prediction Issue
        uses: actions/github-script@v6
        with:
          script: |
            const now = new Date();
            const nextFourHour = new Date(now.getTime() + 4 * 60 * 60 * 1000);
            const price = steps.price.outputs.result;
            
            const title = `[4H Poll] BTCUSDT ë°©í–¥ì„± ì˜ˆì¸¡ (${nextFourHour.toISOString().split('T')[0]} ${nextFourHour.getUTCHours()}:00)`;
            
            const body = `## ğŸ“Š 4ì‹œê°„ ë°©í–¥ì„± íˆ¬í‘œ

### â° íˆ¬í‘œ ê¸°ê°„
- ì‹œì‘: ${now.toISOString()}
- ë§ˆê°: ${nextFourHour.toISOString()}

### ğŸ“ˆ í˜„ì¬ ê°€ê²©: $${parseFloat(price).toFixed(2)}

### íˆ¬í‘œ ë°©ë²•
- ğŸ‘ (ìƒìŠ¹ ì˜ˆìƒ)
- ğŸ‘ (í•˜ë½ ì˜ˆìƒ)

### ë¶„ì„ ê³µìœ 
- ì½”ë©˜íŠ¸ë¡œ ììœ ë¡­ê²Œ ë¶„ì„ì„ ê³µìœ í•´ì£¼ì„¸ìš”
- ê¸°ìˆ ì /í€ë”ë©˜íƒˆ ë¶„ì„ ëª¨ë‘ í™˜ì˜í•©ë‹ˆë‹¤

### ê²°ê³¼ ì§‘ê³„
- 4ì‹œê°„ í›„ ì¢…ê°€ ê¸°ì¤€ìœ¼ë¡œ íŒì •
- ì‹œì‘ ê°€ê²© ëŒ€ë¹„ +/- ë¡œ ìŠ¹íŒ¨ ê²°ì •
- ì •í™•ë„ëŠ” Wiki í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥

### ì£¼ì˜ì‚¬í•­
- ë§ˆê° ì „ê¹Œì§€ ì˜ˆì¸¡ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ì—¬ëŸ¬ ë²ˆ íˆ¬í‘œ ì‹œ ë§ˆì§€ë§‰ íˆ¬í‘œë§Œ ì¸ì •
- ê²°ê³¼ëŠ” ìë™ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['prediction', 'active']
            });

  update-stats:
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'prediction')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          repository: ${{github.repository}}.wiki
          
      - name: Get Final Price
        id: final_price
        uses: actions/github-script@v6
        with:
          script: |
            const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
            const data = await response.json();
            return data.price;
          
      - name: Update Statistics
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const reactions = await github.rest.reactions.listForIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number
            });
            
            // ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ì‹œì‘ ê°€ê²© ì¶”ì¶œ
            const startPriceMatch = issue.body.match(/í˜„ì¬ ê°€ê²©: \$([0-9.]+)/);
            const startPrice = startPriceMatch ? parseFloat(startPriceMatch[1]) : 0;
            const finalPrice = parseFloat(steps.final_price.outputs.result);
            
            // íˆ¬í‘œ ìˆ˜ ê³„ì‚°
            const upVotes = reactions.data.filter(r => r.content === '+1').length;
            const downVotes = reactions.data.filter(r => r.content === '-1').length;
            const totalVotes = reactions.data.length;
            
            // íˆ¬í‘œ ê²°ê³¼ ë¶„ì„
            const actualDirection = finalPrice > startPrice ? 'ìƒìŠ¹' : 'í•˜ë½';
            const majorityPrediction = upVotes > downVotes ? 'ìƒìŠ¹' : 'í•˜ë½';
            const isCorrect = (finalPrice > startPrice && upVotes > downVotes) || 
                            (finalPrice < startPrice && downVotes > upVotes);
            
            // Wiki í˜ì´ì§€ ì½ê¸°
            const wikiPath = 'Prediction-Statistics.md';
            let wikiContent = '';
            try {
              wikiContent = fs.readFileSync(wikiPath, 'utf8');
            } catch (error) {
              console.log('Wiki file not found, creating new one');
              wikiContent = `# 4ì‹œê°„ BTC ì˜ˆì¸¡ í†µê³„\n\n## ì „ì²´ í†µê³„\n`;
            }
            
            // ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸
            let totalPredictions = (wikiContent.match(/ì´ ì˜ˆì¸¡ íšŸìˆ˜: (\d+)/) || [0, 0])[1];
            let correctPredictions = (wikiContent.match(/ì •í™•í•œ ì˜ˆì¸¡ íšŸìˆ˜: (\d+)/) || [0, 0])[1];
            
            totalPredictions = parseInt(totalPredictions) + 1;
            if (isCorrect) {
              correctPredictions = parseInt(correctPredictions) + 1;
            }
            
            const accuracy = ((correctPredictions / totalPredictions) * 100).toFixed(1);
            
            // ìµœê·¼ ì˜ˆì¸¡ ê¸°ë¡ ì—…ë°ì´íŠ¸
            const now = new Date();
            const newRecord = `| ${now.toISOString().split('T')[0]} | $${startPrice.toFixed(2)} | $${finalPrice.toFixed(2)} | ${upVotes} | ${downVotes} | ${actualDirection} | ${majorityPrediction} | ${isCorrect ? 'âœ…' : 'âŒ'} |`;
            
            // ê¸°ì¡´ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸° (ìµœëŒ€ 9ê°œ)
            const recordsMatch = wikiContent.match(/\|.*\|/g) || [];
            const headerRow = '| ë‚ ì§œ | ì‹œì‘ê°€ | ì¢…ê°€ | ìƒìŠ¹í‘œ | í•˜ë½í‘œ | ì‹¤ì œë°©í–¥ | ë‹¤ìˆ˜ê²°ì˜ˆì¸¡ | ì •í™•ì—¬ë¶€ |';
            const formatRow = '|------|--------|------|---------|---------|-----------|------------|----------|';
            let records = [headerRow, formatRow, newRecord];
            
            if (recordsMatch.length > 2) {
              records = records.concat(recordsMatch.slice(2, 11));
            }
            
            // ìƒˆë¡œìš´ Wiki ë‚´ìš© ìƒì„±
            const newWikiContent = `# 4ì‹œê°„ BTC ì˜ˆì¸¡ í†µê³„

## ì „ì²´ í†µê³„
- ì´ ì˜ˆì¸¡ íšŸìˆ˜: ${totalPredictions}
- ì •í™•í•œ ì˜ˆì¸¡ íšŸìˆ˜: ${correctPredictions}
- ì „ì²´ ì •í™•ë„: ${accuracy}%
- ì´ ì°¸ì—¬ì ìˆ˜: ${totalVotes}

## ìµœê·¼ ì˜ˆì¸¡ ê¸°ë¡ (ìµœê·¼ 10ê°œ)
${records.join('\n')}

## ì—…ë°ì´íŠ¸ ë‚´ì—­
ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${now.toISOString()}`;
            
            // Wiki í˜ì´ì§€ ì €ì¥
            fs.writeFileSync(wikiPath, newWikiContent);
            
            // ì´ìŠˆì— ê²°ê³¼ ì½”ë©˜íŠ¸ ì‘ì„±
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `## ğŸ“Š ì˜ˆì¸¡ ê²°ê³¼

- ì‹œì‘ ê°€ê²©: $${startPrice.toFixed(2)}
- ì¢…ë£Œ ê°€ê²©: $${finalPrice.toFixed(2)}
- ì‹¤ì œ ë°©í–¥: ${actualDirection}
- íˆ¬í‘œ ê²°ê³¼: ${upVotes}ëª… ìƒìŠ¹ vs ${downVotes}ëª… í•˜ë½
- ë‹¤ìˆ˜ê²° ì˜ˆì¸¡: ${majorityPrediction}
- ì •í™•ë„: ${isCorrect ? 'âœ… ì •í™•' : 'âŒ ì˜¤ë‹µ'}

í†µê³„ê°€ Wiki í˜ì´ì§€ì— ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`
            }); 