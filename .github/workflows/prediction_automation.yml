name: BTC Price Prediction

on:
  schedule:
    - cron: '0 */4 * * *'  # 4시간마다 실행
  workflow_dispatch:  # 수동 실행 가능

jobs:
  prediction:
    runs-on: ubuntu-latest
    steps:
      - name: Get BTC Price
        id: price
        run: |
          price=$(curl -s https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT | jq -r .price)
          echo "PRICE=$price" >> $GITHUB_ENV

      - name: Create or Close Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 새 예측 이슈 생성
          gh issue create \
            --title "BTC 가격 예측 $(date +%Y-%m-%d_%H)" \
            --body "현재 가격: \$${{ env.PRICE }}

          👍 = 상승 예상
          👎 = 하락 예상

          4시간 후 자동으로 마감됩니다." \
            --label "prediction"

          # 4시간 이상 된 이슈 마감
          gh issue list \
            --label "prediction" \
            --state open \
            --json number,createdAt \
            | jq -r '.[] | select(((now - (.[].createdAt | fromdateiso8601)) / 3600) >= 4) | .number' \
            | xargs -I {} gh issue close {}