name: BTC Price Prediction

on:
  schedule:
    - cron: '0 */4 * * *'  # 4ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  prediction:
    runs-on: ubuntu-latest
    steps:
      - name: Get BTC Price
        id: price
        run: |
          price=$(curl -s https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT | jq -r .price)
          echo "PRICE=$price" >> $GITHUB_ENV

      - name: Create or Close Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ìƒˆ ì˜ˆì¸¡ ì´ìŠˆ ìƒì„±
          gh issue create \
            --title "BTC ê°€ê²© ì˜ˆì¸¡ $(date +%Y-%m-%d_%H)" \
            --body "í˜„ìž¬ ê°€ê²©: \$${{ env.PRICE }}

          ðŸ‘ = ìƒìŠ¹ ì˜ˆìƒ
          ðŸ‘Ž = í•˜ë½ ì˜ˆìƒ

          4ì‹œê°„ í›„ ìžë™ìœ¼ë¡œ ë§ˆê°ë©ë‹ˆë‹¤." \
            --label "prediction"

          # 4ì‹œê°„ ì´ìƒ ëœ ì´ìŠˆ ë§ˆê°
          gh issue list \
            --label "prediction" \
            --state open \
            --json number,createdAt \
            | jq -r '.[] | select(((now - (.[].createdAt | fromdateiso8601)) / 3600) >= 4) | .number' \
            | xargs -I {} gh issue close {}