<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>íŠ¸ë ˆì´ë”© ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´í„°</title>
  <style>
    body { font-family: 'Segoe UI', 'Pretendard', 'Apple SD Gothic Neo', Arial, sans-serif; background: #fcfcfc; color: #222; margin:0; padding:0;}
    header { background: #222; color: #fff; padding: 1.5rem 0 1rem 0; text-align: center;}
    h1 { margin: 0 0 0.5rem 0; font-size:2.2rem;}
    h2 { margin-top:2.5rem;}
    main { max-width: 900px; margin: 2rem auto 3rem auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 14px #0001; padding:2rem;}
    label { font-weight:500; display: inline-block; line-height: 1.5;}
    .form-row { 
      display: flex; 
      align-items: center; 
      gap: 1.5em; 
      margin-bottom: 1em;
      min-height: 36px;
    }
    .form-row label {
      min-width: 180px;
      margin: 0;
      flex-shrink: 0;
    }
    .form-row input[type="number"] { 
      width: 100px; 
      padding: 0.5em;
      height: 36px;
      box-sizing: border-box;
    }
    .form-row input[type="range"] { 
      width: 150px;
      margin: 0;
    }
    .form-row input[type="checkbox"] { 
      width: 1.1em; 
      height: 1.1em;
      margin: 0;
    }
    .desc { 
      color: #555; 
      font-size: 0.97em; 
      margin: 0 0 0 0.5em;
    }
    button { background: #222; color: #fff; font-size:1.1em; border:none; border-radius:5px; padding:0.5em 2em; cursor:pointer; margin-top:1em;}
    button:disabled { opacity:0.6;}
    .progress-bar { background: #e8e8e8; border-radius:10px; overflow:hidden; height:22px; margin:1em 0;}
    .progress-inner { background: #2b72ff; height:100%; transition: width 0.15s;}
    .stats-table { width:100%; border-collapse:collapse; margin-top:1.5em;}
    .stats-table th, .stats-table td { border:1px solid #ddd; padding:0.5em 0.7em; text-align:right;}
    .stats-table th { background: #f3f3f3; color:#222;}
    .stats-table td.metric { background: #f9f9f9; text-align:left;}
    .summary-box { background: #f6faff; border-left: 6px solid #2b72ff; padding:1em 1.5em; margin:2em 0 1em 0; border-radius: 8px;}
    .footer { text-align:center; color:#888; margin:2em 0 1em 0; font-size:0.97em;}
    .badge { background: #2b72ff; color:#fff; border-radius:12px; padding:0.15em 0.9em; font-size:0.83em; margin-left:0.4em;}
    .result-section { margin-top:2em;}
    @media (max-width:650px){
      main { padding:1em; }
      .form-row { flex-direction:column; align-items:flex-start;}
      .stats-table th, .stats-table td { font-size:0.93em;}
    }
  </style>
</head>
<body>
    <!-- ìë™ë§¤ë§¤ ì œì‘ì˜ë¢° ë§í¬ -->
    <div style="position: fixed; top: 10px; right: 10px; z-index: 1000;">
        <a href="https://open.kakao.com/o/sy2UErbd" 
           style="display: inline-block; 
                  background: #ff6b6b; 
                  color: white; 
                  padding: 6px 12px; 
                  border-radius: 15px; 
                  text-decoration: none; 
                  font-weight: bold; 
                  font-size: 0.8rem;
                  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                  transition: all 0.3s ease;">
            ğŸ¤– ìë™ë§¤ë§¤ ì œì‘ì˜ë¢°
        </a>
    </div>
<body>
  <header>
    <h1>íŠ¸ë ˆì´ë”© ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´í„°</h1>
    <div>ì „ëµì˜ ì¥ê¸°ì  ìˆ˜ìµì„±ê³¼ ìœ„í—˜ì„ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ê²€ì¦í•˜ì„¸ìš”</div>
  </header>
  <main>
    <form id="sim-form" autocomplete="off">
      <h2>ì…ë ¥ íŒŒë¼ë¯¸í„°</h2>
      <div class="form-row">
        <label for="capital">ì´ˆê¸° ìë³¸(â‚©)</label>
        <input type="number" id="capital" min="5000" step="1000" value="100000">
        <span class="desc">ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ ì‹œ ë³´ìœ í•œ ì´ˆê¸° ìë³¸ê¸ˆ</span>
      </div>
      <div class="form-row">
        <label for="bet_size">ë² íŒ… ê¸ˆì•¡(â‚©/íšŒ)</label>
        <input type="number" id="bet_size" min="100" step="100" value="3000">
        <span class="desc">ë§¤ ê±°ë˜ë‹¹ íˆ¬ìí•˜ëŠ” ê¸ˆì•¡</span>
      </div>
      <div class="form-row">
        <label for="win_prob">ìŠ¹ë¥ (%)</label>
        <input type="range" id="win_prob" min="5" max="95" step="1" value="35" oninput="winProbOut.value=value">
        <output id="winProbOut">35</output> %
        <span class="desc">ì „ì²´ ê±°ë˜ ì¤‘ ìˆ˜ìµì´ ë°œìƒí•˜ëŠ” ë¹„ìœ¨</span>
      </div>
      <div class="form-row">
        <label for="avg_win_rate">í‰ê·  ìµì ˆë¥ (%)</label>
        <input type="number" id="avg_win_rate" min="0.1" max="100" step="0.01" value="1.4">
        <span class="desc">ì˜ˆ: 1.4 â†’ +1.4% (ìˆ˜ìµ ë°œìƒ ì‹œ í‰ê·  ìˆ˜ìµë¥ )</span>
      </div>
      <div class="form-row">
        <label for="avg_loss_rate">í‰ê·  ì†ì ˆë¥ (%)</label>
        <input type="number" id="avg_loss_rate" max="-0.01" min="-100" step="0.01" value="-0.5">
        <span class="desc">ì˜ˆ: -0.5 â†’ -0.5% (ì†ì‹¤ ë°œìƒ ì‹œ í‰ê·  ì†ì‹¤ë¥ )</span>
      </div>
      <div class="form-row">
        <label for="commission_rate">ìˆ˜ìˆ˜ë£Œ(%)</label>
        <input type="number" id="commission_rate" min="0" max="1" step="0.001" value="0.1">
        <span class="desc">ê±°ë˜ 1íšŒë‹¹(ë§¤ìˆ˜/ë§¤ë„ í•©ì‚°), ì˜ˆ: 0.1 â†’ 0.1%</span>
      </div>
      <div class="form-row">
        <label for="num_trades">ì´ ê±°ë˜ íšŸìˆ˜</label>
        <input type="number" id="num_trades" min="10" max="5000" step="10" value="1000">
        <span class="desc">ì‹œë®¬ë ˆì´ì…˜ì—ì„œ ì‹¤í–‰í•  ì´ ê±°ë˜ íšŸìˆ˜</span>
      </div>
      <div class="form-row">
        <label for="max_streak_simulations">ì‹œë®¬ë ˆì´ì…˜ ë°˜ë³µ(íšŒ)</label>
        <input type="number" id="max_streak_simulations" min="10" max="3000" step="10" value="500">
        <span class="desc">ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ ë°˜ë³µ íšŸìˆ˜ (ë§ì„ìˆ˜ë¡ ì •í™•)</span>
      </div>
      <div class="form-row">
        <label for="cluster_coeff">ì—°ì†ì„±(ìŠ¤í‹°í‚¤)</label>
        <input type="range" id="cluster_coeff" min="0" max="1" step="0.01" value="0.5" oninput="clusterCoeffOut.value=value">
        <output id="clusterCoeffOut">0.5</output>
        <span class="desc">0=ì™„ì „ëœë¤, 1=ì—°ì†ìŠ¹/ì—°ì†íŒ¨ í´ëŸ¬ìŠ¤í„° (ì‹œì¥ì˜ ì¶”ì„¸ ë°˜ì˜)</span>
      </div>
      <div class="form-row">
        <label for="enable_black_swan">ë¸”ë™ìŠ¤ì™„ ì´ë²¤íŠ¸</label>
        <input type="checkbox" id="enable_black_swan" checked>
        <span class="desc">í¬ë°•í•˜ì§€ë§Œ ì¹˜ëª…ì  ì†ì‹¤ ì´ë²¤íŠ¸ í™œì„±í™”</span>
      </div>
      <div class="form-row">
        <label for="black_swan_prob">ë¸”ë™ìŠ¤ì™„ ë°œìƒí™•ë¥ (%)</label>
        <input type="number" id="black_swan_prob" min="0" max="1" step="0.001" value="0.1">
        <span class="desc">ê±°ë˜ 1íšŒë‹¹, ì˜ˆ: 0.1 â†’ 0.1%</span>
      </div>
      <div class="form-row">
        <label for="black_swan_loss_pct">ë¸”ë™ìŠ¤ì™„ ìë³¸ì†ì‹¤(%)</label>
        <input type="number" id="black_swan_loss_pct" min="0" max="100" step="0.1" value="10">
        <span class="desc">ìë³¸ì˜ ëª‡ % ì†ì‹¤, ì˜ˆ: 10 â†’ 10%</span>
      </div>
      <button type="submit" id="run-btn">ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
      <div id="form-error" style="color:#c00; margin-top:0.7em; display:none;"></div>
      <div class="progress-bar" style="display:none;">
        <div class="progress-inner" style="width:0%;"></div>
      </div>
    </form>
    <section class="result-section">
      <div id="result"></div>
    </section>
    <details style="margin-top:2em;">
      <summary><b>Reward/Risk ìš”êµ¬ì¹˜ í‘œ (ì°¸ê³ ìš©)</b></summary>
      <div style="overflow-x:auto; margin-top:1em;">
        <table class="stats-table" style="font-size:0.97em;">
          <thead>
            <tr>
              <th>ìŠ¹ë¥ (%)</th>
              <th>10</th><th>15</th><th>20</th><th>25</th><th>30</th><th>35</th><th>40</th><th>45</th><th>50</th>
              <th>55</th><th>60</th><th>65</th><th>70</th><th>75</th><th>80</th><th>85</th><th>90</th><th>95</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Required R/R</td><td>9.0</td><td>5.7</td><td>4.0</td><td>3.0</td><td>2.3</td><td>1.9</td><td>1.5</td><td>1.2</td><td>1.0</td>
                <td>0.8</td><td>0.7</td><td>0.5</td><td>0.4</td><td>0.3</td><td>0.3</td><td>0.2</td><td>0.1</td><td>0.1</td></tr>
            <tr><td>R/R=1.5+</td><td>13.5</td><td>8.7</td><td>6.0</td><td>4.5</td><td>3.5</td><td>2.8</td><td>2.3</td><td>1.9</td><td>1.5</td>
                <td>1.2</td><td>1.0</td><td>0.8</td><td>0.6</td><td>0.5</td><td>0.4</td><td>0.3</td><td>0.2</td><td>0.1</td></tr>
            <tr><td>R/R=2.0+</td><td>18.0</td><td>11.3</td><td>8.0</td><td>6.0</td><td>4.7</td><td>3.7</td><td>3.0</td><td>2.4</td><td>2.0</td>
                <td>1.6</td><td>1.3</td><td>1.0</td><td>0.7</td><td>0.5</td><td>0.4</td><td>0.3</td><td>0.2</td><td>0.1</td></tr>
            <tr><td>R/R=2.5+</td><td>22.5</td><td>13.9</td><td>10.0</td><td>7.5</td><td>5.8</td><td>4.7</td><td>3.8</td><td>2.8</td><td>2.5</td>
                <td>2.0</td><td>1.7</td><td>1.3</td><td>0.9</td><td>0.7</td><td>0.5</td><td>0.4</td><td>0.2</td><td>0.1</td></tr>
          </tbody>
        </table>
      </div>
      <ul style="margin-top:0.7em; color:#456;">
        <li>Required R/R = (1-ìŠ¹ë¥ )/ìŠ¹ë¥ </li>
        <li>ìœ„ í‘œëŠ” êµ¬ì¡°ì  ìˆ˜ìµì„±(ì¥ê¸°ì ìœ¼ë¡œ ìˆ˜ìµêµ¬ì¡°ê°€ ê°€ëŠ¥í•œì§€) ì°¸ê³ ìš©ì…ë‹ˆë‹¤.</li>
      </ul>
    </details>
  </main>
  <div class="footer">
    <b>Â© 2024-2025 Starfox119</b> | ì˜¤í”ˆì†ŒìŠ¤ ì½”ë“œ ê¸°ë°˜ | <a href="https://github.com/Starfox119" target="_blank">GitHub</a>
  </div>
  <script>
    // =========================
    // Utility (JS version)
    // =========================
    function calcKelly(win_prob, win_rate, loss_rate) {
      const b = loss_rate !== 0 ? win_rate / Math.abs(loss_rate) : 0;
      const p = win_prob;
      const q = 1 - p;
      const kelly = b !== 0 ? (b * p - q) / b : 0;
      return Math.max(0, kelly * 100);
    }
    function minRequiredWinProfit(win_rate, avg_loss, fee_rate) {
      const f = 2 * fee_rate;
      const p = win_rate;
      const L = avg_loss;
      if (p === 0) return Infinity;
      return (f - L) / p + L;
    }
    // =========================
    // Core Simulation (JS)
    // =========================
    function simulateStrategy(cfg, trackStreak=true, trackMdd=true) {
      let wins = 0, losses = 0, total_profit = 0, total_loss = 0, total_commission = 0;
      let streak = 0, max_lose_streak = 0;
      let capital = cfg.initial_capital, max_capital = cfg.initial_capital;
      let mdd = 0, mdd_pct = 0;
      const bet_size = cfg.bet_size;
      const win_prob = cfg.win_prob;
      const avg_win_rate = cfg.avg_win_rate;
      const avg_loss_rate = cfg.avg_loss_rate;
      const num_trades = cfg.num_trades;
      const commission_rate = cfg.commission_rate;
      const cluster_coeff = cfg.cluster_coeff;
      const black_swan_prob = cfg.black_swan_prob;
      const black_swan_loss_pct = cfg.black_swan_loss_pct;
      const enable_black_swan = cfg.enable_black_swan;
      let prev_win = Math.random() < win_prob;
      for(let i=0; i<num_trades; ++i){
        if(capital < bet_size) break;
        // Black Swan
        if(enable_black_swan && Math.random() < black_swan_prob){
          capital -= capital * black_swan_loss_pct;
        }
        // Clustered win/loss
        let curr_win;
        if(Math.random() < cluster_coeff){
          curr_win = prev_win;
        }else{
          curr_win = Math.random() < win_prob;
        }
        const commission = bet_size * commission_rate;
        total_commission += commission;
        if(curr_win){
          const profit = bet_size * avg_win_rate;
          capital += profit - commission;
          total_profit += profit;
          wins += 1;
          if(trackStreak) streak = 0;
          prev_win = true;
        }else{
          const loss = bet_size * Math.abs(avg_loss_rate);
          capital -= (loss + commission);
          total_loss += loss;
          losses += 1;
          if(trackStreak){
            streak += 1;
            if(streak > max_lose_streak) max_lose_streak = streak;
          }
          prev_win = false;
        }
        if(trackMdd){
          if(capital > max_capital){
            max_capital = capital;
          }
          const drawdown = max_capital - capital;
          mdd_pct = Math.max(mdd_pct, (max_capital>0 ? drawdown/max_capital : 0));
          mdd = Math.max(mdd, drawdown);
        }
      }
      const profit_factor = total_loss !== 0 ? (total_profit/total_loss) : (total_profit>0?Infinity:-Infinity);
      const recovery_factor = mdd !== 0 ? (total_profit/mdd) : (total_profit>0?Infinity:-Infinity);
      const seed_change = (capital-cfg.initial_capital)/cfg.initial_capital*100;
      const expectancy = win_prob*avg_win_rate + (1-win_prob)*avg_loss_rate;
      const kelly_pct = calcKelly(win_prob, avg_win_rate, avg_loss_rate);
      return {
        'Final Capital': capital,
        'Seed Change (%)': seed_change,
        'Total Profit': total_profit,
        'Total Loss': total_loss,
        'Profit Factor': profit_factor,
        'Total Commission': total_commission,
        'Win Count': wins,
        'Loss Count': losses,
        'Total Trades': wins+losses,
        'Max Losing Streak': max_lose_streak,
        'Max Drawdown': mdd,
        'Max Drawdown (%)': mdd_pct*100,
        'Recovery Factor': recovery_factor,
        'Expectancy (%)': expectancy*100,
        'Kelly Ratio (%)': kelly_pct
      };
    }
    async function montecarloSimulation(cfg, onProgress) {
      const N = cfg.max_streak_simulations;
      let results = [];
      for(let i=0; i<N; ++i){
        results.push(simulateStrategy(cfg, true, true));
        if(i%10===0 && onProgress) onProgress(i/N);
        // for UI responsiveness
        if(i%50===0) await new Promise(r=>setTimeout(r,0));
      }
      if(onProgress) onProgress(1);
      return results;
    }
    // =========================
    // Statistics & Reporting
    // =========================
    function calcStatsFromList(arr){
      arr = arr.slice().sort((a,b)=>a-b);
      const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
      const median = arr.length%2===1 ? arr[(arr.length-1)/2] : (arr[arr.length/2-1]+arr[arr.length/2])/2;
      const min = arr[0], max = arr[arr.length-1];
      const std = Math.sqrt(arr.reduce((a,b)=>a+(b-mean)*(b-mean),0)/arr.length);
      function percentile(p){
        if(arr.length===0) return 0;
        const idx = Math.ceil((p/100)*arr.length)-1;
        return arr[Math.max(0,Math.min(arr.length-1,idx))];
      }
      return {
        'Median': median,
        'Mean': mean,
        'Min': min,
        'Max': max,
        'Std': std,
        '90%tile': percentile(90),
        '95%tile': percentile(95),
        '99%tile': percentile(99)
      };
    }
    function summarizeMontecarloResults(results, metrics){
      let summary = {};
      for(const metric of metrics){
        summary[metric] = calcStatsFromList(results.map(r=>r[metric]));
      }
      return summary;
    }
    function formatNum(n, digits=2){ 
      if(!isFinite(n)) return 'âˆ';
      return n>=1e6 ? n.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',') : n.toFixed(digits);
    }
    function formatPct(n){
      if(!isFinite(n)) return 'âˆ';
      return (n>=0?'+':'') + n.toFixed(2) + ' %';
    }
    function formatMetricTable(summary, config) {
      const col_order = ["Median", "Mean", "Min", "Max", "Std", "90%tile", "95%tile", "99%tile"];
      const col_names = ["ì¤‘ì•™ê°’", "í‰ê· ", "ìµœì†Œ", "ìµœëŒ€", "í‘œì¤€í¸ì°¨", "90%", "95%", "99%"];
      let rows = [];
      const metrics = Object.keys(summary);
      
      // config rows
      rows.push(['<b>ì´ˆê¸° ìë³¸</b>', ...col_order.map(()=>formatNum(config.initial_capital,0))]);
      rows.push(['<b>ë² íŒ… ê¸ˆì•¡</b>', ...col_order.map(()=>formatNum(config.bet_size,0))]);
      
      // stat rows
      for(const metric of metrics) {
        const isPct = metric.match(/%/);
        const koreanMetric = metricsMap[metric] || metric;
        rows.push([
          koreanMetric,
          ...col_order.map(c=>isPct ? formatPct(summary[metric][c]) : formatNum(summary[metric][c]))
        ]);
      }
      
      // header
      let thead = '<tr><th>ì§€í‘œ</th>' + col_names.map(c=>`<th>${c}</th>`).join('') + '</tr>';
      let tbody = rows.map(r=>'<tr>' + r.map((v,i)=>i===0?`<td class="metric">${v}</td>`:`<td>${v}</td>`).join('') + '</tr>').join('');
      return `<table class="stats-table">${thead}${tbody}</table>`;
    }
    function analyzeStrategy(summary, config){
      const seed_change = summary["Seed Change (%)"]["Mean"];
      const expectancy = summary["Expectancy (%)"]["Mean"];
      const mdd = summary["Max Drawdown (%)"]["Mean"];
      const profit_factor = summary["Profit Factor"]["Mean"];
      const max_streak = summary["Max Losing Streak"]["Mean"];
      const kelly_pct = summary["Kelly Ratio (%)"]["Mean"];
      const min_win_profit = minRequiredWinProfit(
        config.win_prob,
        config.avg_loss_rate,
        config.commission_rate
      );
      const avg_win_rate = config.avg_win_rate;
      let html = `<div class="summary-box"><b>ì „ëµ ì„±ê³¼ ìš”ì•½</b><br/><br/>`;
      html += `<b>ì¼ˆë¦¬ ì´ë¡  ë² íŒ…ë¹„ìœ¨:</b> ${formatPct(kelly_pct)}<br/>`;
      html += `<b>ê¸°ëŒ€ê°’ (Expectancy):</b> ${formatPct(expectancy)}<br/>`;
      html += `<b>í‰ê·  Seed ë³€í™”:</b> ${formatPct(seed_change)}<br/>`;
      html += `<b>í‰ê·  Max Drawdown:</b> ${formatPct(mdd)}<br/>`;
      html += `<b>Profit Factor:</b> ${formatNum(profit_factor)}<br/>`;
      html += `<b>ìµœëŒ€ ì—°ì† ì†ì‹¤:</b> ${formatNum(max_streak,1)}<br/>`;
      html += `<b>ìµœì†Œ ìš”êµ¬ ìµì ˆë¥ :</b> ${formatPct(min_win_profit*100)}<br/>`;
      html += `<b>í˜„ì¬ í‰ê·  ìµì ˆë¥ :</b> ${formatPct(avg_win_rate*100)}<br/>`;
      html += `<hr style="margin:0.7em 0;"/>`;
      if(avg_win_rate < min_win_profit){
        html += `<span style="color:#c00"><b>- í˜„ì¬ í‰ê·  ìµì ˆë¥ ì´ ìµœì†Œ ìš”êµ¬ì¹˜ë³´ë‹¤ ë‚®ì•„ êµ¬ì¡°ì ìœ¼ë¡œ ì ì ì „ëµì…ë‹ˆë‹¤.</b></span><br/>`;
      }else if(seed_change < 0 || expectancy < 0){
        html += `<span style="color:#c00"><b>- ê¸°ëŒ€ê°’ ë˜ëŠ” í‰ê·  seed ë³€í™”ê°€ 0 ì´í•˜ì…ë‹ˆë‹¤. ì¥ê¸°ì ìœ¼ë¡œ ìë³¸ì´ ê°ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</b></span><br/>`;
      }else{
        html += `<span style="color:#295"><b>- ì¥ê¸°ì ìœ¼ë¡œ ìë³¸ì´ ì¦ê°€í•˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.</b></span><br/>`;
      }
      html += `<br/><b>ì¶”ì²œì‚¬í•­</b><ul style="margin-top:0.3em;">`;
      if(avg_win_rate < min_win_profit){
        html += `<li>ìµì ˆë¥ ì„ ë†’ì´ê±°ë‚˜ ì†ì‹¤ë¥ /ìˆ˜ìˆ˜ë£Œë¥¼ ë‚®ì¶”ëŠ” êµ¬ì¡° ê°œì„  í•„ìš”</li>`;
      }
      if(profit_factor < 1.5){
        html += `<li>Profit Factor(ì†ìµë¹„)ê°€ 1.5 ë¯¸ë§Œ â†’ ìˆ˜ìµ/ìœ„í—˜ êµ¬ì¡° ê°œì„  í•„ìš”</li>`;
      }
      if(mdd > 50){
        html += `<li>í‰ê·  Max Drawdownì´ 50% ì´ˆê³¼ â†’ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ê°•í™” í•„ìš”</li>`;
      }
      if(max_streak > 20){
        html += `<li>ìµœëŒ€ ì—°ì† ì†ì‹¤ì´ 20íšŒ ì´ˆê³¼ â†’ í¬ì§€ì…˜ ì‚¬ì´ì¦ˆ/ì†ì ˆ ì „ëµ ì ê²€ í•„ìš”</li>`;
      }
      if(expectancy > 0 && expectancy < 0.5){
        html += `<li>ê¸°ëŒ€ê°’ì´ 0.5% ë¯¸ë§Œ â†’ ì „ëµ ê°œì„  í•„ìš”</li>`;
      }
      if(avg_win_rate >= min_win_profit && seed_change >= 0 && expectancy >= 0 &&
         profit_factor >= 1.5 && mdd <= 50 && max_streak <= 20 && expectancy >= 0.5){
        html += `<li>ëª¨ë“  ì£¼ìš” ë¦¬ìŠ¤í¬/ìˆ˜ìµ ì§€í‘œê°€ ì–‘í˜¸í•©ë‹ˆë‹¤.</li>`;
      }
      html += `</ul></div>`;
      return html;
    }
    // =========================
    // Form & Event Logic
    // =========================
    function getFormConfig(){
      function val(id, fn){ return fn(document.getElementById(id).value);}
      function valC(id){ return document.getElementById(id).checked;}
      return {
        initial_capital: val('capital', Number),
        bet_size: val('bet_size', Number),
        win_prob: val('win_prob', v=>Number(v)/100),
        avg_win_rate: val('avg_win_rate', v=>Number(v)/100),
        avg_loss_rate: val('avg_loss_rate', v=>Number(v)/100),
        num_trades: val('num_trades', Number),
        commission_rate: val('commission_rate', v=>Number(v)/100),
        max_streak_simulations: val('max_streak_simulations', Number),
        cluster_coeff: val('cluster_coeff', Number),
        black_swan_prob: val('black_swan_prob', v=>Number(v)/100),
        black_swan_loss_pct: val('black_swan_loss_pct', v=>Number(v)/100),
        enable_black_swan: valC('enable_black_swan')
      };
    }
    function validateConfig(cfg){
      if(cfg.bet_size > cfg.initial_capital) return "ë² íŒ… ê¸ˆì•¡ì´ ì´ˆê¸° ìë³¸ë³´ë‹¤ í½ë‹ˆë‹¤.";
      if(cfg.win_prob < 0.01 || cfg.win_prob > 0.99) return "ìŠ¹ë¥ ì€ 1~99% ë²”ìœ„ë¡œ ì…ë ¥í•˜ì„¸ìš”.";
      if(cfg.avg_win_rate <= 0) return "í‰ê·  ìµì ˆë¥ ì€ ì–‘ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.";
      if(cfg.avg_loss_rate >= 0) return "í‰ê·  ì†ì ˆë¥ ì€ ìŒìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.";
      if(cfg.num_trades < 10) return "ê±°ë˜íšŸìˆ˜ëŠ” 10íšŒ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
      if(cfg.max_streak_simulations < 10) return "ì‹œë®¬ë ˆì´ì…˜ ë°˜ë³µ íšŸìˆ˜ëŠ” 10íšŒ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
      if(cfg.commission_rate < 0) return "ìˆ˜ìˆ˜ë£ŒëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
      if(cfg.cluster_coeff < 0 || cfg.cluster_coeff>1) return "ì—°ì†ì„±ì€ 0~1 ë²”ìœ„ì—¬ì•¼ í•©ë‹ˆë‹¤.";
      if(cfg.black_swan_prob < 0 || cfg.black_swan_prob > 1) return "ë¸”ë™ìŠ¤ì™„ í™•ë¥ ì€ 0~1% ë²”ìœ„ë¡œ ì…ë ¥í•˜ì„¸ìš”.";
      if(cfg.black_swan_loss_pct < 0 || cfg.black_swan_loss_pct > 1) return "ë¸”ë™ìŠ¤ì™„ ì†ì‹¤ë¥ ì€ 0~100% ë²”ìœ„ë¡œ ì…ë ¥í•˜ì„¸ìš”.";
      return "";
    }
    function showProgress(pct){
      const bar = document.querySelector('.progress-bar');
      const inner = document.querySelector('.progress-inner');
      bar.style.display='block';
      inner.style.width = (pct*100).toFixed(1)+'%';
    }
    function hideProgress(){
      document.querySelector('.progress-bar').style.display='none';
      document.querySelector('.progress-inner').style.width = '0%';
    }
    document.getElementById('sim-form').addEventListener('submit', async function(e){
      e.preventDefault();
      hideProgress();
      document.getElementById('result').innerHTML = '';
      document.getElementById('form-error').style.display='none';
      const cfg = getFormConfig();
      const err = validateConfig(cfg);
      if(err){
        document.getElementById('form-error').innerText=err;
        document.getElementById('form-error').style.display='block';
        return;
      }
      document.getElementById('run-btn').disabled=true;
      showProgress(0);
      
      const metricsMap = {
        "Final Capital": "ìµœì¢… ìë³¸ê¸ˆ",
        "Seed Change (%)": "ìë³¸ê¸ˆ ë³€í™”ìœ¨(%)",
        "Profit Factor": "ìˆ˜ìµ íŒ©í„°",
        "Recovery Factor": "íšŒë³µ íŒ©í„°",
        "Max Drawdown (%)": "ìµœëŒ€ ë‚™í­(%)",
        "Max Losing Streak": "ìµœëŒ€ ì—°íŒ¨",
        "Total Trades": "ì´ ê±°ë˜ìˆ˜",
        "Expectancy (%)": "ê¸°ëŒ€ ìˆ˜ìµë¥ (%)",
        "Kelly Ratio (%)": "ì¼ˆë¦¬ ë¹„ìœ¨(%)"
      };

      // ì˜ë¬¸-í•œê¸€ ì—­ë§¤í•‘ ìƒì„±
      const reverseMetricsMap = Object.fromEntries(
        Object.entries(metricsMap).map(([k, v]) => [v, k])
      );

      const METRICS = [
        "Final Capital", "Seed Change (%)", "Profit Factor", "Recovery Factor",
        "Max Drawdown (%)", "Max Losing Streak", "Total Trades",
        "Expectancy (%)", "Kelly Ratio (%)"
      ];

      function formatMetricTable(summary, config) {
        const col_order = ["Median", "Mean", "Min", "Max", "Std", "90%tile", "95%tile", "99%tile"];
        const col_names = ["ì¤‘ì•™ê°’", "í‰ê· ", "ìµœì†Œ", "ìµœëŒ€", "í‘œì¤€í¸ì°¨", "90%", "95%", "99%"];
        let rows = [];
        const metrics = Object.keys(summary);
        
        // config rows
        rows.push(['<b>ì´ˆê¸° ìë³¸</b>', ...col_order.map(()=>formatNum(config.initial_capital,0))]);
        rows.push(['<b>ë² íŒ… ê¸ˆì•¡</b>', ...col_order.map(()=>formatNum(config.bet_size,0))]);
        
        // stat rows
        for(const metric of metrics) {
          const isPct = metric.includes('%');
          rows.push([
            metricsMap[metric],
            ...col_order.map(c=>isPct ? formatPct(summary[metric][c]) : formatNum(summary[metric][c]))
          ]);
        }
        
        // header
        let thead = '<tr><th>ì§€í‘œ</th>' + col_names.map(c=>`<th>${c}</th>`).join('') + '</tr>';
        let tbody = rows.map(r=>'<tr>' + r.map((v,i)=>i===0?`<td class="metric">${v}</td>`:`<td>${v}</td>`).join('') + '</tr>').join('');
        return `<table class="stats-table">${thead}${tbody}</table>`;
      }

      function analyzeStrategy(summary, config){
        const seed_change = summary["Seed Change (%)"]["Mean"];
        const expectancy = summary["Expectancy (%)"]["Mean"];
        const mdd = summary["Max Drawdown (%)"]["Mean"];
        const profit_factor = summary["Profit Factor"]["Mean"];
        const max_streak = summary["Max Losing Streak"]["Mean"];
        const kelly_pct = summary["Kelly Ratio (%)"]["Mean"];
        const min_win_profit = minRequiredWinProfit(
          config.win_prob,
          config.avg_loss_rate,
          config.commission_rate
        );
        const avg_win_rate = config.avg_win_rate;
        let html = `<div class="summary-box"><b>ì „ëµ ì„±ê³¼ ìš”ì•½</b><br/><br/>`;
        html += `<b>ì¼ˆë¦¬ ì´ë¡  ë² íŒ…ë¹„ìœ¨:</b> ${formatPct(kelly_pct)}<br/>`;
        html += `<b>ê¸°ëŒ€ê°’ (Expectancy):</b> ${formatPct(expectancy)}<br/>`;
        html += `<b>í‰ê·  ìë³¸ê¸ˆ ë³€í™”ìœ¨:</b> ${formatPct(seed_change)}<br/>`;
        html += `<b>í‰ê·  ìµœëŒ€ ë‚™í­:</b> ${formatPct(mdd)}<br/>`;
        html += `<b>ìˆ˜ìµ íŒ©í„°:</b> ${formatNum(profit_factor)}<br/>`;
        html += `<b>ìµœëŒ€ ì—°ì† ì†ì‹¤:</b> ${formatNum(max_streak,1)}<br/>`;
        html += `<b>ìµœì†Œ ìš”êµ¬ ìµì ˆë¥ :</b> ${formatPct(min_win_profit*100)}<br/>`;
        html += `<b>í˜„ì¬ í‰ê·  ìµì ˆë¥ :</b> ${formatPct(avg_win_rate*100)}<br/>`;
        html += `<hr style="margin:0.7em 0;"/>`;
        if(avg_win_rate < min_win_profit){
          html += `<span style="color:#c00"><b>- í˜„ì¬ í‰ê·  ìµì ˆë¥ ì´ ìµœì†Œ ìš”êµ¬ì¹˜ë³´ë‹¤ ë‚®ì•„ êµ¬ì¡°ì ìœ¼ë¡œ ì ì ì „ëµì…ë‹ˆë‹¤.</b></span><br/>`;
        }else if(seed_change < 0 || expectancy < 0){
          html += `<span style="color:#c00"><b>- ê¸°ëŒ€ê°’ ë˜ëŠ” í‰ê·  seed ë³€í™”ê°€ 0 ì´í•˜ì…ë‹ˆë‹¤. ì¥ê¸°ì ìœ¼ë¡œ ìë³¸ì´ ê°ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</b></span><br/>`;
        }else{
          html += `<span style="color:#295"><b>- ì¥ê¸°ì ìœ¼ë¡œ ìë³¸ì´ ì¦ê°€í•˜ëŠ” êµ¬ì¡°ì…ë‹ˆë‹¤.</b></span><br/>`;
        }
        html += `<br/><b>ì¶”ì²œì‚¬í•­</b><ul style="margin-top:0.3em;">`;
        if(avg_win_rate < min_win_profit){
          html += `<li>ìµì ˆë¥ ì„ ë†’ì´ê±°ë‚˜ ì†ì‹¤ë¥ /ìˆ˜ìˆ˜ë£Œë¥¼ ë‚®ì¶”ëŠ” êµ¬ì¡° ê°œì„  í•„ìš”</li>`;
        }
        if(profit_factor < 1.5){
          html += `<li>Profit Factor(ì†ìµë¹„)ê°€ 1.5 ë¯¸ë§Œ â†’ ìˆ˜ìµ/ìœ„í—˜ êµ¬ì¡° ê°œì„  í•„ìš”</li>`;
        }
        if(mdd > 50){
          html += `<li>í‰ê·  Max Drawdownì´ 50% ì´ˆê³¼ â†’ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ê°•í™” í•„ìš”</li>`;
        }
        if(max_streak > 20){
          html += `<li>ìµœëŒ€ ì—°ì† ì†ì‹¤ì´ 20íšŒ ì´ˆê³¼ â†’ í¬ì§€ì…˜ ì‚¬ì´ì¦ˆ/ì†ì ˆ ì „ëµ ì ê²€ í•„ìš”</li>`;
        }
        if(expectancy > 0 && expectancy < 0.5){
          html += `<li>ê¸°ëŒ€ê°’ì´ 0.5% ë¯¸ë§Œ â†’ ì „ëµ ê°œì„  í•„ìš”</li>`;
        }
        if(avg_win_rate >= min_win_profit && seed_change >= 0 && expectancy >= 0 &&
           profit_factor >= 1.5 && mdd <= 50 && max_streak <= 20 && expectancy >= 0.5){
          html += `<li>ëª¨ë“  ì£¼ìš” ë¦¬ìŠ¤í¬/ìˆ˜ìµ ì§€í‘œê°€ ì–‘í˜¸í•©ë‹ˆë‹¤.</li>`;
        }
        html += `</ul></div>`;
        return html;
      }
      const results = await montecarloSimulation(cfg, showProgress);
      hideProgress();
      const summary = summarizeMontecarloResults(results, METRICS);
      let html = '<h2>ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼</h2>';
      html += formatMetricTable(summary, cfg);
      html += analyzeStrategy(summary, cfg);
      document.getElementById('result').innerHTML = html;
      document.getElementById('run-btn').disabled=false;
      window.scrollTo({top:document.getElementById('result').offsetTop-40, behavior:'smooth'});
    });
    // Live output for sliders
    document.getElementById('win_prob').addEventListener('input',function(){ winProbOut.value=this.value; });
    document.getElementById('cluster_coeff').addEventListener('input',function(){ clusterCoeffOut.value=this.value; });
    // Disable black swan probability/loss if unchecked
    document.getElementById('enable_black_swan').addEventListener('change',function(){
      document.getElementById('black_swan_prob').disabled = !this.checked;
      document.getElementById('black_swan_loss_pct').disabled = !this.checked;
      document.getElementById('black_swan_prob').style.background = this.checked?'':'#eee';
      document.getElementById('black_swan_loss_pct').style.background = this.checked?'':'#eee';
    });
    // Init
    if(!document.getElementById('enable_black_swan').checked){
      document.getElementById('black_swan_prob').disabled = true;
      document.getElementById('black_swan_loss_pct').disabled = true;
    }
  </script>
</body>
</html>