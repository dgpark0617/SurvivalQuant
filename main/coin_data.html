<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Data Module</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
        }

        .coin-data-section {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section-title {
            background: #1a1a1a;
            color: #ffffff;
            padding: 25px;  /* 20pxì—ì„œ 25pxë¡œ ì¦ê°€ */
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin: -15px -15px 15px -15px;
        }

        .section-title .title-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .section-title .main-title {
            font-size: 2em;  /* 1.5emì—ì„œ 2emìœ¼ë¡œ ì¦ê°€ */
            font-weight: 600;
        }

        .section-title .sub-title {
            font-size: 1em;  /* 0.9emì—ì„œ 1emìœ¼ë¡œ ì¦ê°€ */
            color: #cccccc;
            font-weight: normal;
        }

        .section-title .update-time {
            font-size: 0.9em;  /* 0.8emì—ì„œ 0.9emìœ¼ë¡œ ì¦ê°€ */
            color: #999;
            font-weight: normal;
            margin-top: 8px;  /* 5pxì—ì„œ 8pxë¡œ ì¦ê°€ */
        }

        .ip-info {
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 10px;
        }

        .ip-label {
            font-weight: 500;
            color: #4e54c8;
            margin-right: 10px;
        }

        .ip-value {
            font-family: 'Courier New', monospace;
            color: #333;
        }

        .coin-table-header {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 2px solid #e9ecef;
            font-weight: 500;
            color: #4e54c8;
            background: #f8f9fa;
            border-radius: 4px 4px 0 0;
            min-height: 40px;
        }

        .coin-table-header .coin-rank,
        .coin-table-header .coin-symbol,
        .coin-table-header .coin-price,
        .coin-table-header .coin-volume,
        .coin-table-header .coin-change,
        .coin-table-header .coin-rate {
            padding: 0 4px;
        }

        .coin-rank {
            flex: 0 0 50px;
            text-align: center;
            white-space: nowrap;
        }

        .coin-symbol {
            flex: 0 0 200px;  /* 120pxì—ì„œ í™•ì¥ */
            padding-left: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coin-logo {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .coin-price {
            flex: 0 0 150px;
            text-align: right;
            white-space: nowrap;
            padding-right: 20px;
        }

        .coin-volume {
            flex: 0 0 150px;
            text-align: right;
            white-space: nowrap;
            padding-right: 20px;
        }

        .coin-change {
            flex: 0 0 100px;
            text-align: right;
            white-space: nowrap;
            padding-right: 10px;
        }

        .coin-rate {
            flex: 0 0 150px;
            text-align: right;
            white-space: nowrap;
            padding-right: 10px;
        }

        .positive { color: #00b894; }
        .negative { color: #ff7675; }

        .coin-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: #ffffff;
            transition: background-color 0.2s;
            min-height: 40px;
            margin: 2px 0;
        }

        .coin-item:hover {
            background: #f8f9fa;
        }

        #coin-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
    </style>
</head>
<body>
    <!-- ìë™ë§¤ë§¤ ì œì‘ì˜ë¢° ë§í¬ -->
    <div style="position: fixed; top: 10px; right: 10px; z-index: 1000;">
        <a href="https://open.kakao.com/o/sy2UErbd" 
           style="display: inline-block; 
                  background: #ff6b6b; 
                  color: white; 
                  padding: 6px 12px; 
                  border-radius: 15px; 
                  text-decoration: none; 
                  font-weight: bold; 
                  font-size: 0.8rem;
                  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                  transition: all 0.3s ease;">
            ğŸ¤– ìë™ë§¤ë§¤ ì œì‘ì˜ë¢°
        </a>
    </div>
    <div class="coin-data-section">
        <div class="section-title">
            <div class="title-text">
                <span class="main-title">ì‹¤ì‹œê°„ ì½”ì¸ ê±°ë˜ëŒ€ê¸ˆ ìˆœìœ„</span>
                <span class="sub-title">ê±°ë˜ëŒ€ê¸ˆ ê¸°ì¤€ìœ¼ë¡œ ì‹¤ì‹œê°„ ìˆœìœ„ë¥¼ í™•ì¸í•˜ì„¸ìš”</span>
                <span class="update-time" id="update-time"></span>
            </div>
        </div>
        
        <div class="coin-table-header">
            <div class="coin-rank">ìˆœìœ„</div>
            <div class="coin-symbol">ì‹¬ë³¼</div>
            <div class="coin-price">ê°€ê²©</div>
            <div class="coin-volume">ê±°ë˜ëŸ‰</div>
            <div class="coin-change">ì²´ê²°</div>
            <div class="coin-rate">ë³€í™”ìœ¨</div>
        </div>
        
        <div id="coin-list">
            <!-- ì½”ì¸ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </div>

    <script>
        let socket = null;
        let coinData = new Map();

        // IP ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                document.getElementById('user-ip').textContent = data.ip;
            } catch (error) {
                document.getElementById('user-ip').textContent = 'Failed to load IP';
            }
        }

        // ë§ˆì¼“ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        async function getMarketCodes() {
            try {
                const response = await fetch('https://api.upbit.com/v1/market/all?isDetails=true');
                const markets = await response.json();
                return markets
                    .filter(market => market.market.startsWith('KRW-'))
                    .map(market => ({
                        market: market.market,
                        korean_name: market.korean_name,
                        symbol: market.market.replace('KRW-', '')
                    }));
            } catch (error) {
                console.error('Failed to fetch market codes:', error);
                return [];
            }
        }

        // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
        function formatNumber(value) {
            if (value >= 1000000000000) { // 1ì¡° ì´ìƒ
                return (value / 1000000000000).toFixed(1) + 'ì¡°ì›';
            } else if (value >= 100000000) { // 1ì–µ ì´ìƒ
                return (value / 100000000).toFixed(1) + 'ì–µì›';
            } else if (value >= 10000000) { // 1ì²œë§Œ ì´ìƒ
                return (value / 10000000).toFixed(1) + 'ì²œë§Œì›';
            } else if (value >= 10000) { // 1ë§Œ ì´ìƒ
                return (value / 10000).toFixed(1) + 'ë§Œì›';
            }
            return value.toLocaleString() + 'ì›';
        }

        // ê°€ê²© í¬ë§·íŒ… í•¨ìˆ˜
        function formatPrice(value) {
            if (value >= 1000000) { // 100ë§Œì› ì´ìƒ
                return (value / 10000).toFixed(1) + 'ë§Œì›';
            }
            return value.toLocaleString() + 'ì›';
        }

        // 10ë¶„ì´ ì§€ë‚œ ë°ì´í„° ì •ë¦¬
        function cleanOldData() {
            const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000); // 10ë¶„ ì „
            for (const [symbol, data] of coinData.entries()) {
                if (data.baseTime < tenMinutesAgo) {
                    // 10ë¶„ ì§€ë‚œ ë°ì´í„°ëŠ” ì´ˆê¸°í™”
                    const currentPrice = data.price;
                    coinData.set(symbol, {
                        ...data,
                        basePrice: currentPrice,
                        baseTime: new Date(),
                        volume: 0,
                        amount: 0,
                        count: 0
                    });
                }
            }
        }

        // ì›¹ì†Œì¼“ ì—°ê²° ë° ë°ì´í„° ì²˜ë¦¬
        async function connectWebSocket() {
            const marketInfos = await getMarketCodes();
            socket = new WebSocket("wss://api.upbit.com/websocket/v1");
            
            // ë§ˆì¼“ ì •ë³´ë¥¼ coinDataì— ë¯¸ë¦¬ ì €ì¥ ë¶€ë¶„ ìˆ˜ì •
            marketInfos.forEach(info => {
                if (!coinData.has(info.symbol)) {
                    coinData.set(info.symbol, {
                        symbol: info.symbol,
                        korean_name: info.korean_name,
                        price: null,  // ì´ˆê¸° ê°€ê²©ì€ nullë¡œ ì„¤ì •
                        basePrice: null,  // ê¸°ì¤€ ê°€ê²©ë„ nullë¡œ ì„¤ì •
                        baseTime: null,  // ê¸°ì¤€ ì‹œê°„ë„ nullë¡œ ì„¤ì •
                        volume: 0,
                        amount: 0,
                        count: 0
                    });
                }
            });
            
            socket.onopen = () => {
                const msg = JSON.stringify([
                    { ticket: "trade" },
                    {
                        type: "trade",
                        codes: marketInfos.map(info => info.market)
                    }
                ]);
                socket.send(msg);
            };

            socket.onmessage = (event) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const data = JSON.parse(reader.result);
                    updateTradeData(data);
                };
                reader.readAsText(event.data);
            };

            socket.onerror = (error) => {
                console.error("WebSocket Error:", error);
            };

            socket.onclose = () => {
                console.log("WebSocket Disconnected. Reconnecting...");
                setTimeout(connectWebSocket, 5000);
            };
        }

        // ì²´ê²° ë°ì´í„° ì—…ë°ì´íŠ¸
        function updateTradeData(data) {
            const code = data.code;
            const symbol = code.replace("KRW-", "");
            const currentPrice = data.trade_price;
            
            if (!coinData.has(symbol)) {
                coinData.set(symbol, {
                    symbol: symbol,
                    korean_name: symbol,
                    price: currentPrice,
                    basePrice: currentPrice,
                    baseTime: new Date(),
                    volume: 0,
                    amount: 0,
                    count: 0
                });
            }

            const coin = coinData.get(symbol);
            
            // ì²« ë°ì´í„°ì¸ ê²½ìš° ê¸°ì¤€ê°€ ì„¤ì •
            if (coin.basePrice === null) {
                coin.basePrice = currentPrice;
                coin.baseTime = new Date();
            }
            
            // ë°ì´í„° ì—…ë°ì´íŠ¸
            coin.price = currentPrice;
            coin.volume += data.trade_volume;
            coin.amount += currentPrice * data.trade_volume;
            coin.count++;

            updateCoinList();
        }

        // ì½”ì¸ ë¦¬ìŠ¤íŠ¸ UI ì—…ë°ì´íŠ¸
        function updateCoinList() {
            const coinList = document.getElementById('coin-list');
            coinList.innerHTML = '';

            let sortedCoins = Array.from(coinData.values())
                .sort((a, b) => b.amount - a.amount);

            sortedCoins.forEach((coin, index) => {
                const timeSinceBase = coin.baseTime ? Math.floor((new Date() - coin.baseTime) / 1000) : 0;
                let timeDisplay;
                if (timeSinceBase < 60) {
                    timeDisplay = `${timeSinceBase}ì´ˆ`;
                } else {
                    timeDisplay = `${Math.floor(timeSinceBase / 60)}ë¶„ ${timeSinceBase % 60}ì´ˆ`;
                }
                
                // ë³€í™”ìœ¨ ê³„ì‚° ë¡œì§ ìˆ˜ì •
                let priceChangeRate = 0;
                let rateClass = '';
                
                if (coin.price !== null && coin.basePrice !== null && coin.basePrice !== 0) {
                    priceChangeRate = ((coin.price - coin.basePrice) / coin.basePrice * 100).toFixed(2);
                    rateClass = priceChangeRate > 0 ? 'positive' : (priceChangeRate < 0 ? 'negative' : '');
                }
                
                const coinItem = document.createElement('div');
                coinItem.className = 'coin-item';
                coinItem.innerHTML = `
                    <div class="coin-rank">${index + 1}</div>
                    <div class="coin-symbol">
                        <img class="coin-logo" src="https://static.upbit.com/logos/${coin.symbol}.png" 
                             onerror="this.src='https://static.upbit.com/logos/none.png'"
                             alt="${coin.symbol}">
                        ${coin.korean_name} (${coin.symbol})
                    </div>
                    <div class="coin-price">${coin.price ? formatPrice(coin.price) : '-'}</div>
                    <div class="coin-volume">${formatNumber(coin.amount)}</div>
                    <div class="coin-change">${coin.count}ê±´</div>
                    <div class="coin-rate ${rateClass}">${priceChangeRate}% (${timeDisplay})</div>
                `;
                
                coinList.appendChild(coinItem);
            });
        }

        // ì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('update-time').textContent = `(${timeStr} ê¸°ì¤€)`;
        }

        // ì´ˆê¸°í™”
        window.onload = () => {
            connectWebSocket();
            updateTime();
            // 1ì´ˆë§ˆë‹¤ ì‹œê°„ ê°±ì‹ 
            setInterval(updateTime, 1000);
            // 30ì´ˆë§ˆë‹¤ ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬
            setInterval(cleanOldData, 30000);
        };

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì›¹ì†Œì¼“ ì—°ê²° í•´ì œ
        window.onbeforeunload = () => {
            if (socket) {
                socket.close();
            }
        };
    </script>
</body>
</html> 