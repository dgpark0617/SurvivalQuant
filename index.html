<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SurvivalQuant</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ----------- Í∏∞Ï°¥ Ïä§ÌÉÄÏùº Ïú†ÏßÄ, ÏùºÎ∂ÄÎßå Í∞úÏÑ† ----------- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #181a20;
            min-height: 100vh;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        .section {
            background: #23262f;
            border: 2px solid #23262f;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.18);
            text-align: center;
        }
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
        }
        .chart-section {
            background: #181a20;
            border: 2px solid #23262f;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.18);
            margin-bottom: 20px;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #e0e0e0;
            margin: 0;
        }
        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .control-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .control-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        .control-btn:hover {
            background: #e9ecef;
        }
        .control-btn.active:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .coin-selector {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            background: white;
            font-size: 1rem;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 15px;
            min-width: 200px;
        }
        .coin-selector:hover { border-color: #667eea; transform: translateY(-2px);}
        .coin-selector:focus { outline: none; border-color: #667eea; box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);}
        .timeframe-legend {
            display: flex; justify-content: center; gap: 20px; margin-top: 15px; flex-wrap: wrap;
        }
        .legend-item { font-size: 0.9rem; font-weight: 600; padding: 5px 10px; border-radius: 15px; background: rgba(255,255,255,0.8);}
        .legend-item.daily { color: #222;}
        .legend-item.hourly4 { color: #FF5733;}
        .legend-item.minute30 { color: #2E7D32;}
        .legend-item.minute5 { color: #1976D2;}
        .legend-item.minute1 { color: #9C27B0;}
        .chart-info { margin-top: 20px; padding: 15px; background: linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6;}
        .info-item { margin-bottom: 8px; font-size: 0.9rem; color: #495057;}
        .info-item:last-child { margin-bottom: 0;}
        .fractal-chart-container {
            position: relative;
            height: 500px;
            width: 100%;
            background: linear-gradient(135deg, #23262f 0%, #181a20 100%);
            border: 3px solid #23262f;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(24, 26, 32, 0.5);
            overflow: hidden;
        }
        .candle-layer {
            position: absolute;
            top: 20px; left: 20px;
            width: calc(100% - 40px) !important;
            height: calc(100% - 40px) !important;
            pointer-events: none;
        }
        .loading {
            display: flex; justify-content: center; align-items: center;
            height: 200px; font-size: 1.1rem; color: #666;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .loading::after { content: '...'; animation: pulse 1.5s infinite; }
        .links-section { grid-column: 1; }
        .ads-section {
            background: #f8f9fa; min-height: 200px; border-style: dashed; display: flex; align-items: center; justify-content: center; color: #6c757d;
        }
        .future-section {
            background: #f1f3f4; min-height: 150px; border-style: dashed; display: flex; align-items: center; justify-content: center; color: #6c757d;
        }
        @media (min-width: 768px) {
            .main-container {
                grid-template-columns: 2fr 1fr;
                grid-template-areas:
                    "header header"
                    "chart chart"
                    "links ads"
                    "games utilities";
            }
            .header-section { grid-area: header; }
            .chart-section { grid-area: chart; }
            .links-section { grid-area: links; }
            .ads-section { grid-area: ads; }
            .games-section { grid-area: games; }
            .utilities-section { grid-area: utilities; }
        }
        h1 { font-size: 1.8rem; margin-bottom: 10px; font-weight: 400; }
        h2 { font-size: 1.8rem; margin-bottom: 20px; font-weight: 400; color: #e0e0e0; }
        h3 { font-size: 1.3rem; margin-bottom: 10px; font-weight: 500; color: #e0e0e0; }
        .url-display {
            background: #f8f9fa; color: #333; padding: 15px 20px; border-radius: 10px;
            font-size: 1.1rem; font-weight: 500; margin: 15px 0; word-break: break-all;
            border: 2px solid #e9ecef; transition: all 0.3s ease;
        }
        .url-display:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2);}
        .copy-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; border: none;
            padding: 12px 25px; border-radius: 25px; cursor: pointer;
            font-size: 1rem; font-weight: 500; transition: all 0.3s ease; margin-top: 15px;
        }
        .copy-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(238,90,36,0.4);}
        .success-message { display: none; color: #2ecc71; font-weight: 500; margin-top: 10px;}
        .link-display {
            background: #f8f9fa; color: #333; padding: 15px 20px; border-radius: 10px; margin: 15px 0;
            border: 2px solid #e9ecef; transition: all 0.3s ease;
        }
        .link-display a {
            color: #0066cc; text-decoration: none; font-size: 1.2rem; font-weight: 500; transition: color 0.3s ease;
        }
        .link-display a:hover { color: #004499; text-decoration: underline; }
        .section-link { display: block; text-decoration: none; color: inherit; transition: all 0.3s ease; position: relative; height: 100%; width: 100%;}
        .section-link:hover { transform: translateY(-2px); color: #333; }
        .link-arrow { position: absolute; bottom: 15px; right: 15px; font-size: 1.5rem; font-weight: bold; opacity: 0.7; transition: all 0.3s ease;}
        .section-link:hover .link-arrow { opacity: 1; transform: translateX(5px);}
        /* Í∑∏Î¶¨Îìú ÎùºÏù∏ Î∞è Ï∂ï ÎùºÎ≤® */
        .fractal-chart-container::before {
            content: '';
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            pointer-events: none;
            background: repeating-linear-gradient(
                to right, #23262f 0px, #23262f 1px, transparent 1px, transparent 60px
            ), repeating-linear-gradient(
                to bottom, #23262f 0px, #23262f 1px, transparent 1px, transparent 60px
            );
            opacity: 0.5;
            z-index: 0;
        }
    </style>
</head>
<body>
<div class="main-container">
    <!-- Ìó§Îçî ÏÑπÏÖò -->
    <div class="section header-section">
        <h1>üöÄ SurvivalQuant</h1>
        <p>EconomicEden - Ïã§ÏãúÍ∞Ñ ÏΩîÏù∏ Ï∞®Ìä∏ Î∞è Ìà¨Ïûê ÎèÑÍµ¨</p>
    </div>

    <!-- ÌîÑÎûôÌÉà Ï∫îÎì§Ïä§Ìã± Ï∞®Ìä∏ ÏÑπÏÖò -->
    <div class="chart-section">
        <div class="chart-header">
            <h2 class="chart-title">üïØÔ∏è ÌîÑÎûôÌÉà Ï∫îÎì§Ïä§Ìã± Ï∞®Ìä∏</h2>
            <div class="chart-controls">
                <label for="mainTfSelector">ÏÉÅÏúÑÎ¥â:</label>
                <select id="mainTfSelector" class="coin-selector">
                    <option value="1h">1ÏãúÍ∞ÑÎ¥â (1H)</option>
                    <option value="4h">4ÏãúÍ∞ÑÎ¥â (4H)</option>
                    <option value="1d">ÏùºÎ¥â (1D)</option>
                </select>
                <label for="subTfSelector">ÌïòÏúÑÎ¥â:</label>
                <select id="subTfSelector" class="coin-selector">
                    <option value="5m">5Î∂ÑÎ¥â (5M)</option>
                    <option value="1m">1Î∂ÑÎ¥â (1M)</option>
                    <option value="15m">15Î∂ÑÎ¥â (15M)</option>
                </select>
                <button class="control-btn active" id="refreshBtn" onclick="refreshChart()">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
            </div>
            <div class="timeframe-legend">
                <span class="legend-item daily">‚ñ† 1ÏãúÍ∞ÑÎ¥â (1H)</span>
                <span class="legend-item minute5">‚ñ† 5Î∂ÑÎ¥â (5M)</span>
            </div>
        </div>
        <div class="fractal-chart-container" id="fractalContainer">
            <canvas id="hourlyCanvas" class="candle-layer" style="z-index: 1;"></canvas>
            <canvas id="minute5Canvas" class="candle-layer" style="z-index: 2;"></canvas>
            <div id="loadingMessage" class="loading">ÌîÑÎûôÌÉà Ï∫îÎì§ Îç∞Ïù¥ÌÑ∞ Î°úÎî©Ï§ë...</div>
        </div>
        <div class="chart-info">
            <div class="info-item"><strong>ÌòÅÏã†Ï†Å Ïª®ÏÖâ:</strong> ÌîÑÎûôÌÉà Íµ¨Ï°∞ Ï∫îÎì§Ïä§Ìã± Ï∞®Ìä∏ (1ÏãúÍ∞ÑÎ¥â + 5Î∂ÑÎ¥â)</div>
            <div class="info-item"><strong>Íµ¨Ï°∞:</strong> 1ÏãúÍ∞ÑÎ¥â ‚Üí 5Î∂ÑÎ¥â(12Í∞ú)</div>
            <div class="info-item"><strong>Ìà¨Î™ÖÎèÑ:</strong> 1ÏãúÍ∞ÑÎ¥â(30%) ‚Üí 5Î∂ÑÎ¥â(Î∂àÌà¨Î™Ö)</div>
        </div>
    </div>

    <!-- ÎßÅÌÅ¨ ÏÑπÏÖò -->
    <div class="section links-section">
        <h2>üîó Ï£ºÏöî ÎßÅÌÅ¨</h2>
        <div class="url-display" id="urlDisplay">
            https://dgpark0617.github.io/SurvivalQuant/
        </div>
        <button class="copy-btn" onclick="copyToClipboard()">
            üìã URL Î≥µÏÇ¨ÌïòÍ∏∞
        </button>
        <div class="success-message" id="successMessage">
            ‚úÖ URLÏù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!
        </div>
        <div class="link-display">
            <a href="https://www.bybit.com/copyMt5/trade-center/detail?providerMark=xkc2wsLqVomphpP%2FtV6RRQ%3D%3D" target="_blank">
                üåü EconomicEden
            </a>
        </div>
        <div class="link-display">
            <a href="https://m.blog.naver.com/economic_eden?tab=1" target="_blank">
                üìñ Í∞úÎ∞úÎ∏îÎ°úÍ∑∏
            </a>
        </div>
        <div class="link-display">
            <a href="https://youtube.com/@economiceden?si=OLHH8h2MZep0oAYA" target="_blank">
                üì∫ Ïú†ÌäúÎ∏å
            </a>
        </div>
        <div class="link-display">
            <a href="https://cryptoinvest.cafe24.com:8080/m/dashboard" target="_blank">
                üí∞ ÌÅ¨Î¶ΩÌÜ† ÎåÄÏãúÎ≥¥Îìú
            </a>
        </div>
    </div>

    <!-- Í¥ëÍ≥† ÏÑπÏÖò -->
    <div class="section ads-section">
        <div>
            <h3>üì∫ Í¥ëÍ≥† Í≥µÍ∞Ñ</h3>
            <p>YouTube Ïï†ÎìúÏÑºÏä§ Î∞è Í¥ëÍ≥†Í∞Ä ÌëúÏãúÎê† ÏòàÏ†ïÏûÖÎãàÎã§</p>
        </div>
    </div>
    <!-- Í≤åÏûÑ ÏÑπÏÖò -->
    <div class="section future-section games-section">
        <a href="games/" class="section-link">
            <h3>üéÆ ÎØ∏Îãà Í≤åÏûÑ</h3>
            <p>Ïû¨ÎØ∏ÏûàÎäî Í≤åÏûÑÎì§ÏùÑ Ï¶êÍ≤®Î≥¥ÏÑ∏Ïöî!</p>
            <div class="link-arrow">‚Üí</div>
        </a>
    </div>
    <!-- Ïú†Ìã∏Î¶¨Ìã∞ ÏÑπÏÖò -->
    <div class="section future-section utilities-section">
        <a href="utilities/" class="section-link">
            <h3>üõ†Ô∏è Ïú†Ìã∏Î¶¨Ìã∞</h3>
            <p>Ïú†Ïö©Ìïú ÎèÑÍµ¨Îì§ÏùÑ ÏÇ¨Ïö©Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
            <div class="link-arrow">‚Üí</div>
        </a>
    </div>
</div>
<script>
    // URL Î≥µÏÇ¨
    function copyToClipboard() {
        const urlText = document.getElementById('urlDisplay').textContent;
        navigator.clipboard.writeText(urlText).then(function() {
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block';
            setTimeout(() => { successMessage.style.display = 'none'; }, 3000);
        });
    }

    // Ï∞®Ìä∏ Í¥ÄÎ†® Î≥ÄÏàò
    let currentSymbol = 'BTCUSDT';
    let candleData = { 'main': [], 'sub': [] };
    let canvasContexts = {};
    let chartDimensions = { width: 0, height: 0 };

    // ÌïòÏù¥ÌÇ®ÏïÑÏãú Î≥ÄÌôò Ìï®Ïàò
    function heikinAshiTransform(candles) {
        if (!candles || candles.length === 0) return [];
        const haCandles = [];
        for (let i = 0; i < candles.length; i++) {
            const prev = haCandles[i - 1] || candles[i];
            const open = i === 0 ? (candles[i].open + candles[i].close) / 2 : (prev.open + prev.close) / 2;
            const close = (candles[i].open + candles[i].high + candles[i].low + candles[i].close) / 4;
            const high = Math.max(candles[i].high, open, close);
            const low = Math.min(candles[i].low, open, close);
            haCandles.push({
                timestamp: candles[i].timestamp,
                open, high, low, close, volume: candles[i].volume
            });
        }
        return haCandles;
    }

    // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÎèôÍ∏∞Ìôî (Î¶¨ÏÇ¨Ïù¥Ï¶à ÎåÄÏùë)
    function resizeCanvases() {
        const canvasIds = ['hourlyCanvas', 'minute5Canvas'];
        const container = document.getElementById('fractalContainer');
        const width = Math.max(300, container.clientWidth - 40);
        const height = Math.max(200, container.clientHeight - 40);
        canvasIds.forEach(canvasId => {
            const canvas = document.getElementById(canvasId);
            canvas.width = width;
            canvas.height = height;
            canvasContexts[canvasId] = canvas.getContext('2d');
        });
        chartDimensions.width = width;
        chartDimensions.height = height;
    }

    // ÌîÑÎûôÌÉà Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
    function initializeFractalChart() {
        resizeCanvases();
        document.getElementById('coinSelector').addEventListener('change', function(e) {
            currentSymbol = e.target.value;
            loadFractalCandleData();
        });
        window.addEventListener('resize', () => {
            resizeCanvases();
            drawFractalCandles();
        });
        loadFractalCandleData();
    }

    // Î∞îÏù¥ÎÇ∏Ïä§ Kline Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
    async function fetchKlineData(symbol, interval, limit) {
        try {
            const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            const data = await response.json();
            return data.map(kline => ({
                timestamp: parseInt(kline[0]),
                open: parseFloat(kline[1]),
                high: parseFloat(kline[2]),
                low: parseFloat(kline[3]),
                close: parseFloat(kline[4]),
                volume: parseFloat(kline[5])
            }));
        } catch (error) {
            console.error(`‚ùå ${symbol} ${interval} Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:`, error);
            return [];
        }
    }

    // ÌÉÄÏûÑÌîÑÎ†àÏûÑ Î∂Ñ Îã®ÏúÑ Î≥ÄÌôò Ìï®Ïàò
    function tfToMinutes(tf) {
        if (tf.endsWith('m')) return parseInt(tf);
        if (tf.endsWith('h')) return parseInt(tf) * 60;
        if (tf.endsWith('d')) return parseInt(tf) * 60 * 24;
        return 1;
    }

    // ÏÉÅÏúÑ/ÌïòÏúÑ ÌÉÄÏûÑÌîÑÎ†àÏûÑ ÏÑ†ÌÉùÍ∞í
    let mainTf = '1h';
    let subTf = '5m';
    document.getElementById('mainTfSelector').addEventListener('change', function(e) {
        mainTf = e.target.value;
        loadFractalCandleData();
    });
    document.getElementById('subTfSelector').addEventListener('change', function(e) {
        subTf = e.target.value;
        loadFractalCandleData();
    });

    // ÌîÑÎûôÌÉà Ï∫îÎì§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÏÉÅÏúÑ/ÌïòÏúÑ ÌÉÄÏûÑÌîÑÎ†àÏûÑ Î∞òÏòÅ)
    async function loadFractalCandleData() {
        document.getElementById('loadingMessage').style.display = 'flex';
        try {
            const mainLimit = 24;
            const subLimit = mainLimit * (tfToMinutes(mainTf) / tfToMinutes(subTf));
            const requests = [
                fetchKlineData(currentSymbol, mainTf, mainLimit),
                fetchKlineData(currentSymbol, subTf, subLimit)
            ];
            const [mainData, subData] = await Promise.all(requests);
            candleData['main'] = mainData;
            candleData['sub'] = subData;
            candleData['main_ha'] = heikinAshiTransform(mainData);
            candleData['sub_ha'] = heikinAshiTransform(subData);
            drawFractalCandles();
            document.getElementById('loadingMessage').style.display = 'none';
        } catch (error) {
            document.getElementById('loadingMessage').innerHTML = `
                <div style="text-align: center; color: #ff4757;">
                    ‚ùå ÌîÑÎûôÌÉà Ï∫îÎì§ Îç∞Ïù¥ÌÑ∞ Î°úÎî©Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§<br>
                    <small style="color: #666; font-size: 0.9rem;">ÏóêÎü¨: ${error.message}</small>
                </div>
            `;
        }
    }

    // ÌïòÏù¥ÌÇ®ÏïÑÏãú Í∏∞Ï§Ä Í∞ÄÍ≤© Î≤îÏúÑ Í≥ÑÏÇ∞
    function calculatePriceRangeHA() {
        let allPrices = [];
        ['main_ha', 'sub_ha'].forEach(key => {
            (candleData[key] || []).forEach(candle => {
                allPrices.push(candle.high, candle.low);
            });
        });
        if (allPrices.length === 0) return { min: 0, max: 100 };
        const min = Math.min(...allPrices);
        const max = Math.max(...allPrices);
        const padding = (max - min) * 0.1;
        return { min: min - padding, max: max + padding };
    }

    // Í∞Å ÌÉÄÏûÑÌîÑÎ†àÏûÑÎ≥Ñ Ï∫îÎì§ Ìè≠/Í∞ÑÍ≤© Í≥ÑÏÇ∞
    function getCandleRenderParams(timeframe) {
        const data = candleData[timeframe] || [];
        if (!data.length) return {candleWidth: 4, spacing: 2};
        const maxArea = chartDimensions.width * 0.90;
        const candleCount = data.length;
        let candleWidth = Math.max(3, Math.min(16, maxArea / (candleCount*1.5)));
        let spacing = Math.max(1, candleWidth * 0.3);
        return {candleWidth, spacing};
    }

    // ÌîÑÎûôÌÉà Ï∫îÎì§ Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞ (ÏÉÅÏúÑ/ÌïòÏúÑ ÌÉÄÏûÑÌîÑÎ†àÏûÑ Ïò§Î≤ÑÎ†àÏù¥)
    function drawFractalCandles() {
        Object.values(canvasContexts).forEach(ctx => ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height));
        const priceRange = calculatePriceRangeHA();
        drawMainCandlesHA('main_ha', 'hourlyCanvas', priceRange, 0.30, '#222222');
        drawSubCandlesHA('sub_ha', 'minute5Canvas', priceRange, 1.00, '#1976D2');
    }

    // ÏÉÅÏúÑÎ¥â(Î©îÏù∏) Ï∫îÎì§ Í∑∏Î¶¨Í∏∞: Ï†ÑÏ≤¥ xÏ∂ï Í∑†Îì± Î∂ÑÌï†
    function drawMainCandlesHA(timeframe, canvasId, priceRange, opacity, color) {
        const ctx = canvasContexts[canvasId];
        const data = candleData[timeframe];
        if (!data || data.length === 0) return;
        const count = data.length;
        const totalWidth = chartDimensions.width;
        const candleWidth = Math.max(8, totalWidth / (count * 1.5));
        const spacing = (totalWidth - candleWidth * count) / (count + 1);
        data.forEach((candle, i) => {
            const x = spacing + i * (candleWidth + spacing);
            drawSingleCandle(ctx, x, candle, candleWidth, priceRange, opacity, color);
        });
    }

    // ÌïòÏúÑÎ¥â(ÏÑúÎ∏å) Ï∫îÎì§ Í∑∏Î¶¨Í∏∞: Í∞Å ÏÉÅÏúÑÎ¥â Íµ¨Í∞Ñ ÎÇ¥ NÍ∞ú Í∑†Îì± Î∂ÑÌï†
    function drawSubCandlesHA(timeframe, canvasId, priceRange, opacity, color) {
        const ctx = canvasContexts[canvasId];
        const subData = candleData[timeframe];
        const mainData = candleData['main_ha'];
        if (!subData || !mainData || subData.length === 0 || mainData.length === 0) return;
        const mainCount = mainData.length;
        const subPerMain = Math.round(subData.length / mainCount);
        const totalWidth = chartDimensions.width;
        const mainCandleWidth = Math.max(8, totalWidth / (mainCount * 1.5));
        const mainSpacing = (totalWidth - mainCandleWidth * mainCount) / (mainCount + 1);
        for (let i = 0; i < mainCount; i++) {
            const mainX = mainSpacing + i * (mainCandleWidth + mainSpacing);
            const subStart = i * subPerMain;
            const subEnd = subStart + subPerMain;
            const subCandles = subData.slice(subStart, subEnd);
            const subCandleWidth = Math.max(2, mainCandleWidth / (subPerMain * 1.2));
            const subSpacing = (mainCandleWidth - subCandleWidth * subPerMain) / (subPerMain + 1);
            subCandles.forEach((candle, j) => {
                const x = mainX + subSpacing + j * (subCandleWidth + subSpacing);
                drawSingleCandle(ctx, x, candle, subCandleWidth, priceRange, opacity, color);
            });
        }
    }

    // Îã®Ïùº Ï∫îÎì§ Í∑∏Î¶¨Í∏∞ (Ìä∏Î†àÏù¥Îî©Î∑∞ Ïä§ÌÉÄÏùº)
    function drawSingleCandle(ctx, x, candle, width, priceRange, opacity, color) {
        const getY = (price) => {
            const ratio = (price - priceRange.min) / (priceRange.max - priceRange.min);
            return chartDimensions.height - (ratio * chartDimensions.height);
        };
        const openY = getY(candle.open), closeY = getY(candle.close), highY = getY(candle.high), lowY = getY(candle.low);
        const isUp = candle.close >= candle.open;
        const bodyColor = isUp ? "#26a69a" : "#ef5350";
        ctx.globalAlpha = opacity;
        ctx.shadowBlur = 8;
        ctx.shadowColor = isUp ? "#26a69a55" : "#ef535055";

        // Ï∫îÎì§ Î™∏ÌÜµ
        ctx.fillStyle = bodyColor;
        const bodyTop = Math.min(openY, closeY);
        const bodyHeight = Math.max(1, Math.abs(closeY - openY));
        if (bodyHeight > 1.2) {
            ctx.fillRect(x, bodyTop, width, bodyHeight);
        } else {
            ctx.strokeStyle = bodyColor;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(x, openY);
            ctx.lineTo(x + width, openY);
            ctx.stroke();
        }

        // Íº¨Î¶¨ (wick)
        ctx.shadowBlur = 0;
        ctx.strokeStyle = color;
        ctx.lineWidth = Math.max(1, width / 6);
        ctx.beginPath();
        ctx.moveTo(x + width / 2, highY);
        ctx.lineTo(x + width / 2, lowY);
        ctx.stroke();

        ctx.globalAlpha = 1.0;
    }

    // Ï∞®Ìä∏ ÏÉàÎ°úÍ≥†Ïπ®
    function refreshChart() {
        loadFractalCandleData();
    }

    // Ï≤´ Î†åÎçîÎßÅ
    document.addEventListener('DOMContentLoaded', function() {
        initializeFractalChart();
    });
</script>
</body>
</html>
