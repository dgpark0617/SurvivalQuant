<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SurvivalQuant</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        .section {
            background: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
        }
        
        .chart-section {
            background: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .control-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .control-btn:hover {
            background: #e9ecef;
        }
        
        .control-btn.active:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        
        .chart-container {
            position: relative;
            height: 450px;
            width: 100%;
            background: #ffffff;
            border: 3px solid #007bff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0, 123, 255, 0.2);
        }
        
        #upbitChart {
            width: 100% !important;
            height: 400px !important;
            background: #fafafa;
            border: 1px solid #ddd;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .stat-item.positive {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        
        .stat-item.negative {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }
        
        .stat-change {
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .positive .stat-change {
            color: #28a745;
        }
        
        .negative .stat-change {
            color: #dc3545;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.1rem;
            color: #666;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading::after {
            content: '...';
            animation: pulse 1.5s infinite;
        }
        
        .links-section {
            grid-column: 1;
        }
        
        .ads-section {
            background: #f8f9fa;
            min-height: 200px;
            border-style: dashed;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }
        
        .future-section {
            background: #f1f3f4;
            min-height: 150px;
            border-style: dashed;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }
        
        @media (min-width: 768px) {
            .main-container {
                grid-template-columns: 2fr 1fr;
                grid-template-areas: 
                    "header header"
                    "chart chart"
                    "links ads"
                    "games utilities";
            }
            
            .header-section { grid-area: header; }
            .chart-section { grid-area: chart; }
            .links-section { grid-area: links; }
            .ads-section { grid-area: ads; }
            .games-section { grid-area: games; }
            .utilities-section { grid-area: utilities; }
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            font-weight: 400;
        }
        
        h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            font-weight: 400;
            color: #333;
        }
        
        h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 500;
            color: #555;
        }
        
        .url-display {
            background: #f8f9fa;
            color: #333;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 500;
            margin: 15px 0;
            word-break: break-all;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .url-display:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .copy-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(238, 90, 36, 0.4);
        }
        
        .description {
            margin-top: 20px;
            font-size: 1rem;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        .success-message {
            display: none;
            color: #2ecc71;
            font-weight: 500;
            margin-top: 10px;
        }
        
        .link-display {
            background: #f8f9fa;
            color: #333;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .link-display a {
            color: #0066cc;
            text-decoration: none;
            font-size: 1.2rem;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .link-display a:hover {
            color: #004499;
            text-decoration: underline;
        }
        
        .section-link {
            display: block;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s ease;
            position: relative;
            height: 100%;
            width: 100%;
        }
        
        .section-link:hover {
            transform: translateY(-2px);
            color: #333;
        }
        
        .link-arrow {
            position: absolute;
            bottom: 15px;
            right: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        
        .section-link:hover .link-arrow {
            opacity: 1;
            transform: translateX(5px);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Ìó§Îçî ÏÑπÏÖò -->
        <div class="section header-section">
            <h1>üöÄ SurvivalQuant</h1>
            <p>EconomicEden - Ïã§ÏãúÍ∞Ñ ÏΩîÏù∏ Ï∞®Ìä∏ Î∞è Ìà¨Ïûê ÎèÑÍµ¨</p>
        </div>
        
        <!-- ÏóÖÎπÑÌä∏ Ïã§ÏãúÍ∞Ñ Ï∞®Ìä∏ ÏÑπÏÖò -->
        <div class="chart-section">
            <div class="chart-header">
                <h2 class="chart-title">üìä ÏóÖÎπÑÌä∏ Ïã§ÏãúÍ∞Ñ ÏΩîÏù∏ Î≥ÄÌôîÏú®</h2>
                <div class="chart-controls">
                    <button class="control-btn active" id="changeBtn" onclick="switchMode('change')">Î≥ÄÌôîÏú® (%)</button>
                    <button class="control-btn" id="priceBtn" onclick="switchMode('price')">Ïã§Ï†ú Í∞ÄÍ≤©</button>
                    <button class="control-btn" id="topBtn" onclick="toggleTopCoins()">Top 20</button>
                    <button class="control-btn" id="resetBtn" onclick="resetChart()">Ï∞®Ìä∏ Î¶¨ÏÖã</button>
                </div>
            </div>
            
            <!-- Ï∞®Ìä∏ ÌëúÏãú Í≥µÍ∞Ñ (ÌôïÏã§Ìûà Î≥¥Ïù¥Îäî Î≤ÑÏ†Ñ) -->
            <div style="background: linear-gradient(45deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%); 
                        border: 5px solid #ff4757; 
                        border-radius: 15px; 
                        padding: 30px; 
                        margin: 20px 0; 
                        min-height: 500px;
                        box-shadow: 0 10px 30px rgba(255, 71, 87, 0.3);">
                
                <h2 style="text-align: center; color: #2f3542; font-size: 2rem; margin-bottom: 20px;">
                    üìä ÏóÖÎπÑÌä∏ Ïã§ÏãúÍ∞Ñ Ï∞®Ìä∏ ÏòÅÏó≠
                </h2>
                
                <div style="background: white; 
                           border: 3px dashed #5f27cd; 
                           border-radius: 10px; 
                           height: 400px; 
                           display: flex; 
                           align-items: center; 
                           justify-content: center;
                           font-size: 1.5rem;
                           color: #5f27cd;
                           font-weight: bold;">
                    
                    üéØ Ïó¨Í∏∞Ïóê Ï∞®Ìä∏Í∞Ä ÌëúÏãúÎê©ÎãàÎã§ üéØ
                    <br><br>
                    (ÌòÑÏû¨ Ï∞®Ìä∏ Î°úÎî© Ï§ë...)
                    
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button style="background: #3742fa; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; margin: 5px;">
                        Î≥ÄÌôîÏú® (%)
                    </button>
                    <button style="background: #2ed573; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; margin: 5px;">
                        Ïã§Ï†ú Í∞ÄÍ≤©
                    </button>
                    <button style="background: #ffa502; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; margin: 5px;">
                        Top 20
                    </button>
                    <button style="background: #ff4757; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; margin: 5px;">
                        Ï∞®Ìä∏ Î¶¨ÏÖã
                    </button>
                </div>
                
                <!-- Ïã§Ï†ú CanvasÎäî Ïà®Í≤®ÎëêÍ≥† ÎÇòÏ§ëÏóê ÌôúÏÑ±Ìôî -->
                <canvas id="upbitChart" style="display: none;"></canvas>
                <div id="loadingMessage" style="display: none;">Î°úÎî©Ï§ë</div>
                
            </div>
            
            <div class="stats-container" id="statsContainer">
                <!-- ÌÜµÍ≥Ñ Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </div>
        
        <!-- ÎßÅÌÅ¨ ÏÑπÏÖò -->
        <div class="section links-section">
            <h2>üîó Ï£ºÏöî ÎßÅÌÅ¨</h2>
            
            <div class="url-display" id="urlDisplay">
                https://dgpark0617.github.io/SurvivalQuant/
            </div>
            <button class="copy-btn" onclick="copyToClipboard()">
                üìã URL Î≥µÏÇ¨ÌïòÍ∏∞
            </button>
            <div class="success-message" id="successMessage">
                ‚úÖ URLÏù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!
            </div>
            
            <div class="link-display">
                <a href="https://www.bybit.com/copyMt5/trade-center/detail?providerMark=xkc2wsLqVomphpP%2FtV6RRQ%3D%3D" target="_blank">
                    üåü EconomicEden
                </a>
            </div>
            
            <div class="link-display">
                <a href="https://m.blog.naver.com/economic_eden?tab=1" target="_blank">
                    üìñ Í∞úÎ∞úÎ∏îÎ°úÍ∑∏
                </a>
            </div>
            
            <div class="link-display">
                <a href="https://youtube.com/@economiceden?si=OLHH8h2MZep0oAYA" target="_blank">
                    üì∫ Ïú†ÌäúÎ∏å
                </a>
            </div>
            
            <div class="link-display">
                <a href="https://cryptoinvest.cafe24.com:8080/m/dashboard" target="_blank">
                    üí∞ ÌÅ¨Î¶ΩÌÜ† ÎåÄÏãúÎ≥¥Îìú
                </a>
            </div>
        </div>
        
        <!-- Í¥ëÍ≥† ÏÑπÏÖò -->
        <div class="section ads-section">
            <div>
                <h3>üì∫ Í¥ëÍ≥† Í≥µÍ∞Ñ</h3>
                <p>YouTube Ïï†ÎìúÏÑºÏä§ Î∞è Í¥ëÍ≥†Í∞Ä ÌëúÏãúÎê† ÏòàÏ†ïÏûÖÎãàÎã§</p>
            </div>
        </div>
        
        <!-- Í≤åÏûÑ ÏÑπÏÖò -->
        <div class="section future-section games-section">
            <a href="games/" class="section-link">
                <h3>üéÆ ÎØ∏Îãà Í≤åÏûÑ</h3>
                <p>Ïû¨ÎØ∏ÏûàÎäî Í≤åÏûÑÎì§ÏùÑ Ï¶êÍ≤®Î≥¥ÏÑ∏Ïöî!</p>
                <div class="link-arrow">‚Üí</div>
            </a>
        </div>
        
        <!-- Ïú†Ìã∏Î¶¨Ìã∞ ÏÑπÏÖò -->
        <div class="section future-section utilities-section">
            <a href="utilities/" class="section-link">
                <h3>üõ†Ô∏è Ïú†Ìã∏Î¶¨Ìã∞</h3>
                <p>Ïú†Ïö©Ìïú ÎèÑÍµ¨Îì§ÏùÑ ÏÇ¨Ïö©Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
                <div class="link-arrow">‚Üí</div>
            </a>
        </div>
    </div>

    <script>
        // Í∏∞Ï°¥ URL Î≥µÏÇ¨ Í∏∞Îä•
        function copyToClipboard() {
            const urlText = document.getElementById('urlDisplay').textContent;
            navigator.clipboard.writeText(urlText).then(function() {
                const successMessage = document.getElementById('successMessage');
                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000);
            });
        }
        
        // ÏóÖÎπÑÌä∏ Ï∞®Ìä∏ Í¥ÄÎ†® Î≥ÄÏàòÎì§
        let upbitChart = null;
        let upbitWebSocket = null;
        let coinData = new Map();
        let displayMode = 'change'; // 'change' or 'price'
        let showTopOnly = false;
        let baselinePrices = new Map(); // Í∏∞Ï§ÄÍ∞ÄÍ≤© Ï†ÄÏû•
        let chartStartTime = null;
        
        // ÏÉâÏÉÅ ÌåîÎ†àÌä∏ (200Í∞ú ÏΩîÏù∏ÏùÑ ÏúÑÌïú Îã§ÏñëÌïú ÏÉâÏÉÅ)
        const colorPalette = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
            '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56',
            '#8B5CF6', '#10B981', '#F59E0B', '#EF4444', '#3B82F6', '#8B5A2B',
            '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1', '#14B8A6',
            '#F472B6', '#A78BFA', '#FB7185', '#34D399', '#FBBF24', '#60A5FA'
        ];
        
        // Îß§Ïö∞ Í∞ÑÎã®Ìïú ÌÖåÏä§Ìä∏ Ï∞®Ìä∏ ÏÉùÏÑ±
        function initializeUpbitChart() {
            console.log('=== Ï∞®Ìä∏ ÌÖåÏä§Ìä∏ ÏãúÏûë ===');
            
            // 5Ï¥à ÌõÑÏóê Ï∞®Ìä∏ ÏòÅÏó≠ÏùÑ Ïã§Ï†ú Ï∞®Ìä∏Î°ú ÍµêÏ≤¥
            setTimeout(() => {
                console.log('Ï∞®Ìä∏ ÏòÅÏó≠ ÍµêÏ≤¥ ÏãúÎèÑ...');
                
                const chartArea = document.querySelector('div[style*="Ïó¨Í∏∞Ïóê Ï∞®Ìä∏Í∞Ä ÌëúÏãúÎê©ÎãàÎã§"]');
                if (chartArea) {
                    // Chart.js ÏÇ¨Ïö© Í∞ÄÎä•ÌïúÏßÄ ÌôïÏù∏
                    if (typeof Chart !== 'undefined') {
                        // Ï∞®Ìä∏ ÏòÅÏó≠ÏùÑ CanvasÎ°ú ÍµêÏ≤¥
                        chartArea.innerHTML = '<canvas id="realChart" width="800" height="400"></canvas>';
                        
                        const canvas = document.getElementById('realChart');
                        const ctx = canvas.getContext('2d');
                        
                        // Îß§Ïö∞ Í∞ÑÎã®Ìïú Ï∞®Ìä∏ ÏÉùÏÑ±
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: ['1Î∂Ñ', '2Î∂Ñ', '3Î∂Ñ', '4Î∂Ñ', '5Î∂Ñ'],
                                datasets: [{
                                    label: 'ÎπÑÌä∏ÏΩîÏù∏ ÌÖåÏä§Ìä∏',
                                    data: [100, 105, 98, 110, 108],
                                    borderColor: '#ff6b6b',
                                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                                    borderWidth: 3,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                        
                        console.log('‚úÖ ÌÖåÏä§Ìä∏ Ï∞®Ìä∏ ÏÉùÏÑ± ÏÑ±Í≥µ!');
                        
                    } else {
                        console.error('Chart.js ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏóÜÏùå');
                        chartArea.innerHTML = '‚ùå Chart.js ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§';
                    }
                } else {
                    console.error('Ï∞®Ìä∏ ÏòÅÏó≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                }
            }, 5000);
        }
        
        // ÏóÖÎπÑÌä∏ ÎßàÏºì Î¶¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
        async function getUpbitMarkets() {
            const response = await fetch('https://api.upbit.com/v1/market/all');
            const markets = await response.json();
            return markets
                .filter(market => market.market.startsWith('KRW-'))
                .map(market => market.market);
        }
        
        // ÌòÑÏû¨ Í∞ÄÍ≤© Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        async function getCurrentPrices(markets) {
            const marketString = markets.join(',');
            const response = await fetch(`https://api.upbit.com/v1/ticker?markets=${marketString}`);
            return await response.json();
        }
        
        // Í∏∞Ï°¥ Î≥µÏû°Ìïú Ìï®ÏàòÎì§ Ï†úÍ±∞ÌïòÍ≥† Îã®ÏàúÌôî
        
        // Ïã§Ï†ú ÏóÖÎπÑÌä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        async function loadRealUpbitData() {
            try {
                const markets = await getUpbitMarkets();
                const initialPrices = await getCurrentPrices(markets.slice(0, 20)); // Ï≤òÏùåÏóî 20Í∞úÎßå
                
                console.log(`${initialPrices.length}Í∞ú ÏΩîÏù∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å`);
                
                // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Î°ú Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                updateChartWithRealData(initialPrices);
                
                // WebSocket Ïó∞Í≤∞
                connectWebSocket(markets.slice(0, 20));
                
            } catch (error) {
                console.error('Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            }
        }
        
        // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Î°ú Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateChartWithRealData(priceData) {
            if (!upbitChart) return;
            
            chartStartTime = new Date();
            const timeIndex = 0;
            
            // Í∏∞Ï°¥ ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞
            upbitChart.data.datasets = [];
            
            // Ïã§Ï†ú ÏΩîÏù∏ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
            priceData.forEach((coin, index) => {
                const symbol = coin.market;
                const price = coin.trade_price;
                
                // Í∏∞Ï§ÄÍ∞ÄÍ≤© ÏÑ§Ï†ï
                baselinePrices.set(symbol, price);
                coinData.set(symbol, {
                    prices: [price],
                    changes: [0],
                    timestamps: [chartStartTime],
                    name: symbol.replace('KRW-', ''),
                    basePrice: price
                });
                
                // Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ÏÖã Ï∂îÍ∞Ä
                const color = colorPalette[index % colorPalette.length];
                upbitChart.data.datasets.push({
                    label: symbol.replace('KRW-', ''),
                    data: [{x: timeIndex, y: 0}], // Ï¥àÍ∏∞ Î≥ÄÌôîÏú® 0%
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 1.5,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 1
                });
            });
            
            upbitChart.update();
            
            // Î°úÎî© Î©îÏãúÏßÄ Ïà®Í∏∞Í∏∞
            document.getElementById('loadingMessage').style.display = 'none';
            
            console.log('Ïã§Ï†ú ÏóÖÎπÑÌä∏ Îç∞Ïù¥ÌÑ∞Î°ú Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        }
        
        // WebSocket Ïó∞Í≤∞
        function connectWebSocket(markets) {
            upbitWebSocket = new WebSocket('wss://api.upbit.com/websocket/v1');
            
            upbitWebSocket.onopen = () => {
                console.log('WebSocket Ïó∞Í≤∞Îê®');
                const subscription = [{
                    ticket: 'upbit-chart',
                    type: 'ticker',
                    codes: markets
                }];
                upbitWebSocket.send(JSON.stringify(subscription));
            };
            
            upbitWebSocket.onmessage = (event) => {
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const data = JSON.parse(reader.result);
                        updateCoinData(data);
                    } catch (error) {
                        console.error('WebSocket Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò:', error);
                    }
                };
                reader.readAsText(event.data);
            };
            
            upbitWebSocket.onerror = (error) => {
                console.error('WebSocket Ïò§Î•ò:', error);
            };
            
            upbitWebSocket.onclose = () => {
                console.log('WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å');
                // 5Ï¥à ÌõÑ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ
                setTimeout(() => {
                    if (markets) {
                        connectWebSocket(markets);
                    }
                }, 5000);
            };
        }
        
        // ÏΩîÏù∏ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCoinData(tickerData) {
            const symbol = tickerData.code;
            const currentPrice = tickerData.trade_price;
            const now = new Date();
            
            if (coinData.has(symbol)) {
                const data = coinData.get(symbol);
                const basePrice = data.basePrice;
                
                // Î°úÍ∑∏ Í∏∞Î∞ò Î≥ÄÌôîÏú® Í≥ÑÏÇ∞ (Í∏∞Ï§ÄÍ∞ÄÍ≤© ÎåÄÎπÑ)
                const changePercent = ((currentPrice - basePrice) / basePrice) * 100;
                
                // Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
                data.prices.push(currentPrice);
                data.changes.push(changePercent);
                data.timestamps.push(now);
                
                // 200Í∞ú Îç∞Ïù¥ÌÑ∞ Ìè¨Ïù∏Ìä∏ Ïú†ÏßÄ
                if (data.prices.length > 200) {
                    data.prices.shift();
                    data.changes.shift();
                    data.timestamps.shift();
                }
                
                // Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ (1Ï¥àÎßàÎã§)
                throttledUpdateChart(symbol, data);
            }
        }
        
        // Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ Ïì∞Î°úÌãÄÎßÅ (5Ï¥à Í∞ÑÍ≤©)
        let lastChartUpdate = 0;
        let updateQueue = new Set();
        
        function throttledUpdateChart(symbol, data) {
            updateQueue.add(symbol);
            
            const now = Date.now();
            if (now - lastChartUpdate > 5000) { // 5Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
                batchUpdateChart();
                lastChartUpdate = now;
                console.log('Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏Îê® (5Ï¥à Í∞ÑÍ≤©)');
            }
        }
        
        function batchUpdateChart() {
            if (!upbitChart) {
                console.log('Ï∞®Ìä∏Í∞Ä ÏïÑÏßÅ Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏùå');
                return;
            }
            
            console.log('Ï∞®Ìä∏ Î∞∞Ïπò ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë...');
            
            // ÌëúÏãúÌï† ÏΩîÏù∏ ÌïÑÌÑ∞ÎßÅ
            const coinsToShow = getDisplayCoins();
            console.log(`ÌëúÏãúÌï† ÏΩîÏù∏ Ïàò: ${coinsToShow.length}`);
            
            // Í∏∞Ï°¥ datasets Ï†ïÎ¶¨ (Ï≤´ 2Í∞ú ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï†úÏô∏ÌïòÍ≥†)
            const realDatasets = [];
            
            // ÏÑ†ÌÉùÎêú ÏΩîÏù∏Îì§Îßå Ï∞®Ìä∏Ïóê Ï∂îÍ∞Ä
            coinsToShow.forEach((symbol, index) => {
                const data = coinData.get(symbol);
                if (data && data.timestamps.length > 0) {
                    const color = colorPalette[index % colorPalette.length];
                    const values = displayMode === 'change' ? data.changes : data.prices;
                    
                    // ÏãúÍ∞Ñ Í∏∞Î∞ò xÏ∂ï Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (5Ï¥à Í∞ÑÍ≤©)
                    const chartData = data.timestamps.map((time, idx) => ({
                        x: idx * 5, // 5Ï¥à Í∞ÑÍ≤©ÏúºÎ°ú ÌëúÏãú
                        y: values[idx]
                    }));
                    
                    realDatasets.push({
                        label: data.name,
                        data: chartData,
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 1.5,
                        fill: false,
                        tension: 0.1,
                        pointRadius: 1
                    });
                }
            });
            
            // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ ÎåÄÏ≤¥
            if (realDatasets.length > 0) {
                upbitChart.data.datasets = realDatasets;
            }
            
            upbitChart.update('none');
            updateStats();
            updateQueue.clear();
            
            console.log('Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
        }
        
        // ÌëúÏãúÌï† ÏΩîÏù∏ ÏÑ†ÌÉù
        function getDisplayCoins() {
            let coins = Array.from(coinData.entries())
                .filter(([symbol, data]) => data.timestamps.length > 1)
                .map(([symbol, data]) => ({
                    symbol,
                    change: data.changes[data.changes.length - 1] || 0,
                    price: data.prices[data.prices.length - 1] || 0
                }));
            
            if (showTopOnly) {
                // Î≥ÄÌôîÏú® Ï†àÎåìÍ∞í Í∏∞Ï§Ä ÏÉÅÏúÑ 20Í∞ú
                coins = coins
                    .sort((a, b) => Math.abs(b.change) - Math.abs(a.change))
                    .slice(0, 20);
            }
            
            return coins.map(coin => coin.symbol);
        }
        
        // ÌÜµÍ≥Ñ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            const statsContainer = document.getElementById('statsContainer');
            
            const coins = Array.from(coinData.entries())
                .map(([symbol, data]) => ({
                    symbol,
                    name: data.name,
                    change: data.changes[data.changes.length - 1] || 0,
                    price: data.prices[data.prices.length - 1] || 0
                }))
                .filter(coin => coin.change !== 0);
            
            // ÏÉÅÏúÑ 5Í∞ú, ÌïòÏúÑ 5Í∞ú Ï∂îÏ∂ú
            const sortedByChange = [...coins].sort((a, b) => b.change - a.change);
            const topGainers = sortedByChange.slice(0, 5);
            const topLosers = sortedByChange.slice(-5).reverse();
            
            let statsHTML = '';
            
            // ÏÉÅÏäπ ÏÉÅÏúÑ 5Í∞ú
            statsHTML += '<h3 style="grid-column: 1 / -1; margin: 10px 0; color: #28a745;">üìà ÏÉÅÏäπÎ•† Top 5</h3>';
            topGainers.forEach(coin => {
                statsHTML += `
                    <div class="stat-item positive">
                        <div class="stat-label">${coin.name}</div>
                        <div class="stat-value">${coin.price.toLocaleString()}Ïõê</div>
                        <div class="stat-change">+${coin.change.toFixed(2)}%</div>
                    </div>
                `;
            });
            
            // ÌïòÎùΩ ÏÉÅÏúÑ 5Í∞ú
            statsHTML += '<h3 style="grid-column: 1 / -1; margin: 10px 0; color: #dc3545;">üìâ ÌïòÎùΩÎ•† Top 5</h3>';
            topLosers.forEach(coin => {
                statsHTML += `
                    <div class="stat-item negative">
                        <div class="stat-label">${coin.name}</div>
                        <div class="stat-value">${coin.price.toLocaleString()}Ïõê</div>
                        <div class="stat-change">${coin.change.toFixed(2)}%</div>
                    </div>
                `;
            });
            
            statsContainer.innerHTML = statsHTML;
        }
        
        // Î™®Îìú Ï†ÑÌôò (Î≥ÄÌôîÏú®/Í∞ÄÍ≤©)
        function switchMode(mode) {
            displayMode = mode;
            
            // Î≤ÑÌäº ÌôúÏÑ±Ìôî ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(mode + 'Btn').classList.add('active');
            
            // YÏ∂ï ÎùºÎ≤® Î≥ÄÍ≤Ω
            if (upbitChart) {
                upbitChart.options.scales.y.title.text = 
                    displayMode === 'change' ? 'Î≥ÄÌôîÏú® (%)' : 'Í∞ÄÍ≤© (Ïõê)';
                batchUpdateChart();
            }
        }
        
        // Top 20 ÌÜ†Í∏Ä
        function toggleTopCoins() {
            showTopOnly = !showTopOnly;
            const btn = document.getElementById('topBtn');
            btn.textContent = showTopOnly ? 'Ï†ÑÏ≤¥ Î≥¥Í∏∞' : 'Top 20';
            btn.classList.toggle('active');
            
            if (upbitChart) {
                batchUpdateChart();
            }
        }
        
        // Ï∞®Ìä∏ Î¶¨ÏÖã
        function resetChart() {
            chartStartTime = new Date();
            
            // Î™®Îì† ÏΩîÏù∏Ïùò Í∏∞Ï§ÄÍ∞ÄÍ≤©ÏùÑ ÌòÑÏû¨Í∞ÄÍ≤©ÏúºÎ°ú Î¶¨ÏÖã
            coinData.forEach((data, symbol) => {
                if (data.prices.length > 0) {
                    const currentPrice = data.prices[data.prices.length - 1];
                    data.basePrice = currentPrice;
                    data.prices = [currentPrice];
                    data.changes = [0];
                    data.timestamps = [chartStartTime];
                }
            });
            
            if (upbitChart) {
                batchUpdateChart();
            }
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            // GitHub URL ÏóÖÎç∞Ïù¥Ìä∏ (Í∏∞Ï°¥ Í∏∞Îä•)
            // const actualUrl = 'https://Ïã§Ï†úÏÇ¨Ïö©ÏûêÎ™Ö.github.io/SurvivalQuant/';
            // document.getElementById('urlDisplay').textContent = actualUrl;
            
            // ÏóÖÎπÑÌä∏ Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
            initializeUpbitChart();
        });
        
        // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å
        window.addEventListener('beforeunload', function() {
            if (upbitWebSocket) {
                upbitWebSocket.close();
            }
        });
    </script>
</body>
</html>