<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Data Module</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
        }

        .coin-data-section {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section-title {
            background: #1a1a1a;
            color: #ffffff;
            padding: 25px;  /* 20px에서 25px로 증가 */
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin: -15px -15px 15px -15px;
        }

        .section-title .title-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .section-title .main-title {
            font-size: 2em;  /* 1.5em에서 2em으로 증가 */
            font-weight: 600;
        }

        .section-title .sub-title {
            font-size: 1em;  /* 0.9em에서 1em으로 증가 */
            color: #cccccc;
            font-weight: normal;
        }

        .section-title .update-time {
            font-size: 0.9em;  /* 0.8em에서 0.9em으로 증가 */
            color: #999;
            font-weight: normal;
            margin-top: 8px;  /* 5px에서 8px로 증가 */
        }

        .ip-info {
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 10px;
        }

        .ip-label {
            font-weight: 500;
            color: #4e54c8;
            margin-right: 10px;
        }

        .ip-value {
            font-family: 'Courier New', monospace;
            color: #333;
        }

        .coin-table-header {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 2px solid #e9ecef;
            font-weight: 500;
            color: #4e54c8;
            background: #f8f9fa;
            border-radius: 4px 4px 0 0;
            min-height: 40px;
        }

        .coin-table-header .coin-rank,
        .coin-table-header .coin-symbol,
        .coin-table-header .coin-price,
        .coin-table-header .coin-volume,
        .coin-table-header .coin-change,
        .coin-table-header .coin-rate {
            padding: 0 4px;
        }

        .coin-rank {
            flex: 0 0 50px;
            text-align: center;
            white-space: nowrap;
        }

        .coin-symbol {
            flex: 0 0 200px;  /* 120px에서 확장 */
            padding-left: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coin-logo {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .coin-price {
            flex: 0 0 150px;
            text-align: right;
            white-space: nowrap;
            padding-right: 20px;
        }

        .coin-volume {
            flex: 0 0 150px;
            text-align: right;
            white-space: nowrap;
            padding-right: 20px;
        }

        .coin-change {
            flex: 0 0 100px;
            text-align: right;
            white-space: nowrap;
            padding-right: 10px;
        }

        .coin-rate {
            flex: 0 0 150px;
            text-align: right;
            white-space: nowrap;
            padding-right: 10px;
        }

        .positive { color: #00b894; }
        .negative { color: #ff7675; }

        .coin-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: #ffffff;
            transition: background-color 0.2s;
            min-height: 40px;
            margin: 2px 0;
        }

        .coin-item:hover {
            background: #f8f9fa;
        }

        #coin-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
    </style>
</head>
<body>
    <div class="coin-data-section">
        <div class="section-title">
            <div class="title-text">
                <span class="main-title">실시간 코인 거래대금 순위</span>
                <span class="sub-title">거래대금 기준으로 실시간 순위를 확인하세요</span>
                <span class="update-time" id="update-time"></span>
            </div>
        </div>
        
        <div class="coin-table-header">
            <div class="coin-rank">순위</div>
            <div class="coin-symbol">심볼</div>
            <div class="coin-price">가격</div>
            <div class="coin-volume">거래량</div>
            <div class="coin-change">체결</div>
            <div class="coin-rate">변화율</div>
        </div>
        
        <div id="coin-list">
            <!-- 코인 데이터가 여기에 동적으로 추가됩니다 -->
        </div>
    </div>

    <script>
        let socket = null;
        let coinData = new Map();

        // IP 주소 가져오기
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                document.getElementById('user-ip').textContent = data.ip;
            } catch (error) {
                document.getElementById('user-ip').textContent = 'Failed to load IP';
            }
        }

        // 마켓 코드 가져오기
        async function getMarketCodes() {
            try {
                const response = await fetch('https://api.upbit.com/v1/market/all?isDetails=true');
                const markets = await response.json();
                return markets
                    .filter(market => market.market.startsWith('KRW-'))
                    .map(market => ({
                        market: market.market,
                        korean_name: market.korean_name,
                        symbol: market.market.replace('KRW-', '')
                    }));
            } catch (error) {
                console.error('Failed to fetch market codes:', error);
                return [];
            }
        }

        // 숫자 포맷팅 함수
        function formatNumber(value) {
            if (value >= 1000000000000) { // 1조 이상
                return (value / 1000000000000).toFixed(1) + '조원';
            } else if (value >= 100000000) { // 1억 이상
                return (value / 100000000).toFixed(1) + '억원';
            } else if (value >= 10000000) { // 1천만 이상
                return (value / 10000000).toFixed(1) + '천만원';
            } else if (value >= 10000) { // 1만 이상
                return (value / 10000).toFixed(1) + '만원';
            }
            return value.toLocaleString() + '원';
        }

        // 가격 포맷팅 함수
        function formatPrice(value) {
            if (value >= 1000000) { // 100만원 이상
                return (value / 10000).toFixed(1) + '만원';
            }
            return value.toLocaleString() + '원';
        }

        // 10분이 지난 데이터 정리
        function cleanOldData() {
            const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000); // 10분 전
            for (const [symbol, data] of coinData.entries()) {
                if (data.baseTime < tenMinutesAgo) {
                    // 10분 지난 데이터는 초기화
                    const currentPrice = data.price;
                    coinData.set(symbol, {
                        ...data,
                        basePrice: currentPrice,
                        baseTime: new Date(),
                        volume: 0,
                        amount: 0,
                        count: 0
                    });
                }
            }
        }

        // 웹소켓 연결 및 데이터 처리
        async function connectWebSocket() {
            const marketInfos = await getMarketCodes();
            socket = new WebSocket("wss://api.upbit.com/websocket/v1");
            
            // 마켓 정보를 coinData에 미리 저장 부분 수정
            marketInfos.forEach(info => {
                if (!coinData.has(info.symbol)) {
                    coinData.set(info.symbol, {
                        symbol: info.symbol,
                        korean_name: info.korean_name,
                        price: null,  // 초기 가격은 null로 설정
                        basePrice: null,  // 기준 가격도 null로 설정
                        baseTime: null,  // 기준 시간도 null로 설정
                        volume: 0,
                        amount: 0,
                        count: 0
                    });
                }
            });
            
            socket.onopen = () => {
                const msg = JSON.stringify([
                    { ticket: "trade" },
                    {
                        type: "trade",
                        codes: marketInfos.map(info => info.market)
                    }
                ]);
                socket.send(msg);
            };

            socket.onmessage = (event) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const data = JSON.parse(reader.result);
                    updateTradeData(data);
                };
                reader.readAsText(event.data);
            };

            socket.onerror = (error) => {
                console.error("WebSocket Error:", error);
            };

            socket.onclose = () => {
                console.log("WebSocket Disconnected. Reconnecting...");
                setTimeout(connectWebSocket, 5000);
            };
        }

        // 체결 데이터 업데이트
        function updateTradeData(data) {
            const code = data.code;
            const symbol = code.replace("KRW-", "");
            const currentPrice = data.trade_price;
            
            if (!coinData.has(symbol)) {
                coinData.set(symbol, {
                    symbol: symbol,
                    korean_name: symbol,
                    price: currentPrice,
                    basePrice: currentPrice,
                    baseTime: new Date(),
                    volume: 0,
                    amount: 0,
                    count: 0
                });
            }

            const coin = coinData.get(symbol);
            
            // 첫 데이터인 경우 기준가 설정
            if (coin.basePrice === null) {
                coin.basePrice = currentPrice;
                coin.baseTime = new Date();
            }
            
            // 데이터 업데이트
            coin.price = currentPrice;
            coin.volume += data.trade_volume;
            coin.amount += currentPrice * data.trade_volume;
            coin.count++;

            updateCoinList();
        }

        // 코인 리스트 UI 업데이트
        function updateCoinList() {
            const coinList = document.getElementById('coin-list');
            coinList.innerHTML = '';

            let sortedCoins = Array.from(coinData.values())
                .sort((a, b) => b.amount - a.amount);

            sortedCoins.forEach((coin, index) => {
                const timeSinceBase = coin.baseTime ? Math.floor((new Date() - coin.baseTime) / 1000) : 0;
                let timeDisplay;
                if (timeSinceBase < 60) {
                    timeDisplay = `${timeSinceBase}초`;
                } else {
                    timeDisplay = `${Math.floor(timeSinceBase / 60)}분 ${timeSinceBase % 60}초`;
                }
                
                // 변화율 계산 로직 수정
                let priceChangeRate = 0;
                let rateClass = '';
                
                if (coin.price !== null && coin.basePrice !== null && coin.basePrice !== 0) {
                    priceChangeRate = ((coin.price - coin.basePrice) / coin.basePrice * 100).toFixed(2);
                    rateClass = priceChangeRate > 0 ? 'positive' : (priceChangeRate < 0 ? 'negative' : '');
                }
                
                const coinItem = document.createElement('div');
                coinItem.className = 'coin-item';
                coinItem.innerHTML = `
                    <div class="coin-rank">${index + 1}</div>
                    <div class="coin-symbol">
                        <img class="coin-logo" src="https://static.upbit.com/logos/${coin.symbol}.png" 
                             onerror="this.src='https://static.upbit.com/logos/none.png'"
                             alt="${coin.symbol}">
                        ${coin.korean_name} (${coin.symbol})
                    </div>
                    <div class="coin-price">${coin.price ? formatPrice(coin.price) : '-'}</div>
                    <div class="coin-volume">${formatNumber(coin.amount)}</div>
                    <div class="coin-change">${coin.count}건</div>
                    <div class="coin-rate ${rateClass}">${priceChangeRate}% (${timeDisplay})</div>
                `;
                
                coinList.appendChild(coinItem);
            });
        }

        // 시간 업데이트 함수
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('update-time').textContent = `(${timeStr} 기준)`;
        }

        // 초기화
        window.onload = () => {
            connectWebSocket();
            updateTime();
            // 1초마다 시간 갱신
            setInterval(updateTime, 1000);
            // 30초마다 오래된 데이터 정리
            setInterval(cleanOldData, 30000);
        };

        // 페이지 종료 시 웹소켓 연결 해제
        window.onbeforeunload = () => {
            if (socket) {
                socket.close();
            }
        };
    </script>
</body>
</html> 